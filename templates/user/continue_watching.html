{% extends "base.html" %} {% block title %}Continue Watching - CineWave{%
endblock %} {% block content %}
<div class="container mt-5 pt-5">
  <!-- Page Header -->
  <div class="row mb-5">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h1 class="h2" style="color: var(--text-primary)">
          <i
            class="fas fa-play-circle me-2"
            style="color: var(--primary-blue)"
          ></i
          >Continue Watching
        </h1>
        {% if continue_watching_items %}
        <div class="dropdown">
          <button
            class="btn btn-outline-primary dropdown-toggle"
            type="button"
            data-bs-toggle="dropdown"
            aria-expanded="false"
          >
            <i class="fas fa-filter me-2"></i>Filter
          </button>
          <ul class="dropdown-menu dropdown-menu-end">
            <li>
              <a class="dropdown-item" href="?filter=recent">Most Recent</a>
            </li>
            <li>
              <a class="dropdown-item" href="?filter=progress">Progress</a>
            </li>
            <li>
              <a class="dropdown-item" href="?filter=alphabetical"
                >Alphabetical</a
              >
            </li>
          </ul>
        </div>
        {% endif %}
      </div>
      <p class="text-secondary">
        Pick up where you left off across all your profiles.
      </p>
    </div>
  </div>

  <!-- Profile Tabs -->
  {% if profiles|length > 1 %}
  <div class="row mb-4">
    <div class="col-12">
      <div
        class="card"
        style="background: var(--card-bg); border-color: var(--border-color)"
      >
        <div class="card-body">
          <h6 class="card-title mb-3">Filter by Profile</h6>
          <div class="d-flex flex-wrap gap-2">
            <a
              href="{{ url_for('continue_watching') }}"
              class="btn btn-sm {% if not selected_profile %}btn-primary{% else %}btn-outline-primary{% endif %}"
            >
              All Profiles
            </a>
            {% for profile in profiles %}
            <a
              href="{{ url_for('continue_watching', profile_id=profile.id) }}"
              class="btn btn-sm {% if selected_profile and selected_profile.id == profile.id %}btn-primary{% else %}btn-outline-primary{% endif %}"
            >
              {{ profile.name }} {% if profile.is_active %}
              <span class="badge bg-success ms-1">Active</span>
              {% endif %}
            </a>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Continue Watching Items -->
  {% if continue_watching_items %}
  <div class="row">
    <div class="col-12">
      <!-- Stats Summary -->
      <div class="row mb-4">
        <div class="col-md-4 mb-3">
          <div
            class="card"
            style="
              background: var(--card-bg);
              border-color: var(--border-color);
            "
          >
            <div class="card-body">
              <div class="d-flex align-items-center">
                <div class="me-3">
                  <i
                    class="fas fa-film fa-2x"
                    style="color: var(--primary-blue)"
                  ></i>
                </div>
                <div>
                  <div class="fs-4 fw-bold">
                    {{ continue_watching_items|length }}
                  </div>
                  <div class="text-secondary small">Total Items</div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-4 mb-3">
          <div
            class="card"
            style="
              background: var(--card-bg);
              border-color: var(--border-color);
            "
          >
            <div class="card-body">
              <div class="d-flex align-items-center">
                <div class="me-3">
                  <i
                    class="fas fa-clock fa-2x"
                    style="color: var(--primary-blue)"
                  ></i>
                </div>
                <div>
                  <div class="fs-4 fw-bold">{{ total_watch_time_hours }}h</div>
                  <div class="text-secondary small">Total Watch Time</div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-4 mb-3">
          <div
            class="card"
            style="
              background: var(--card-bg);
              border-color: var(--border-color);
            "
          >
            <div class="card-body">
              <div class="d-flex align-items-center">
                <div class="me-3">
                  <i
                    class="fas fa-chart-line fa-2x"
                    style="color: var(--primary-blue)"
                  ></i>
                </div>
                <div>
                  <div class="fs-4 fw-bold">{{ average_progress }}%</div>
                  <div class="text-secondary small">Average Progress</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Items Grid -->
      <div class="row">
        {% for item in continue_watching_items %}
        <div class="col-md-6 col-lg-4 col-xl-3 mb-4">
          <div class="movie-card h-100 position-relative">
            <!-- Progress Badge -->
            <div class="position-absolute top-0 end-0 m-2">
              <span
                class="badge"
                style="
                  background-color: var(--primary-blue);
                  color: var(--primary-dark);
                "
              >
                {{ "%.0f"|format(item.progress_percentage) }}%
              </span>
            </div>

            <!-- Profile Badge -->
            {% if not selected_profile %}
            <div class="position-absolute top-0 start-0 m-2">
              <span class="badge bg-secondary">
                <i class="fas fa-user me-1"></i>{{ item.profile.name }}
              </span>
            </div>
            {% endif %}

            <!-- Movie Poster -->
            <a
              href="{{ url_for('movie_detail', movie_id=item.movie.id) }}"
              class="text-decoration-none"
            >
              <div class="position-relative">
                <img
                  src="{{ item.movie.poster_url or 'https://via.placeholder.com/400x600/172a45/8892b0?text=No+Poster' }}"
                  alt="{{ item.movie.title }}"
                  class="img-fluid w-100"
                  style="height: 300px; object-fit: cover"
                />

                <!-- Progress Bar -->
                <div class="position-absolute bottom-0 start-0 w-100">
                  <div class="progress" style="height: 4px; border-radius: 0">
                    <div
                      class="progress-bar"
                      role="progressbar"
                      style="width: {{ item.progress_percentage }}%"
                    ></div>
                  </div>
                </div>

                <!-- Play Button Overlay -->
                <div class="position-absolute top-50 start-50 translate-middle">
                  <button
                    class="btn btn-primary btn-lg rounded-circle"
                    style="width: 60px; height: 60px; opacity: 0.9"
                    onclick="playFromTimestamp('{{ item.movie.id }}', {{ item.current_time }})"
                  >
                    <i class="fas fa-play"></i>
                  </button>
                </div>
              </div>
            </a>

            <!-- Movie Info -->
            <div class="movie-info">
              <div
                class="d-flex justify-content-between align-items-start mb-2"
              >
                <a
                  href="{{ url_for('movie_detail', movie_id=item.movie.id) }}"
                  class="text-decoration-none"
                >
                  <h6 class="movie-title mb-0">{{ item.movie.title }}</h6>
                </a>
                <div class="dropdown">
                  <button
                    class="btn btn-sm btn-outline-secondary border-0"
                    type="button"
                    data-bs-toggle="dropdown"
                  >
                    <i class="fas fa-ellipsis-v"></i>
                  </button>
                  <ul class="dropdown-menu dropdown-menu-end">
                    <li>
                      <a
                        class="dropdown-item"
                        href="#"
                        onclick="playFromTimestamp('{{ item.movie.id }}', {{ item.current_time }})"
                      >
                        <i class="fas fa-play me-2"></i>Continue from {{
                        item.current_time|format_time }}
                      </a>
                    </li>
                    <li>
                      <a
                        class="dropdown-item"
                        href="#"
                        onclick="playFromBeginning('{{ item.movie.id }}')"
                      >
                        <i class="fas fa-redo me-2"></i>Start from Beginning
                      </a>
                    </li>
                    <li><hr class="dropdown-divider" /></li>
                    <li>
                      <a
                        class="dropdown-item"
                        href="#"
                        onclick="removeFromContinueWatching('{{ item.id }}')"
                      >
                        <i class="fas fa-trash me-2 text-danger"></i>Remove from
                        List
                      </a>
                    </li>
                  </ul>
                </div>
              </div>

              <div
                class="d-flex justify-content-between align-items-center mb-2"
              >
                <div>
                  <small class="text-secondary">
                    <i class="fas fa-clock me-1"></i>
                    {{ (item.current_time // 60)|int }}m / {{ (item.duration //
                    60)|int }}m
                  </small>
                </div>
                <div>
                  <small class="text-secondary">
                    <i class="fas fa-calendar me-1"></i>
                    {{ item.updated_at.strftime('%b %d') }}
                  </small>
                </div>
              </div>

              <!-- Action Buttons -->
              <div class="d-flex gap-2">
                <button
                  class="btn btn-sm btn-primary flex-grow-1"
                  onclick="playFromTimestamp('{{ item.movie.id }}', {{ item.current_time }})"
                >
                  <i class="fas fa-play me-2"></i>Continue
                </button>
                <a
                  href="{{ url_for('movie_detail', movie_id=item.movie.id) }}"
                  class="btn btn-sm btn-outline-primary"
                >
                  <i class="fas fa-info-circle"></i>
                </a>
              </div>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>

      <!-- Pagination -->
      {% if total_pages > 1 %}
      <nav aria-label="Page navigation" class="mt-5">
        <ul class="pagination justify-content-center">
          {% if page > 1 %}
          <li class="page-item">
            <a
              class="page-link"
              href="?page={{ page-1 }}{% if selected_profile %}&profile_id={{ selected_profile.id }}{% endif %}"
            >
              <i class="fas fa-chevron-left"></i>
            </a>
          </li>
          {% endif %} {% for p in range(1, total_pages + 1) %} {% if p >= page-2
          and p <= page+2 %}
          <li class="page-item {% if p == page %}active{% endif %}">
            <a
              class="page-link"
              href="?page={{ p }}{% if selected_profile %}&profile_id={{ selected_profile.id }}{% endif %}"
            >
              {{ p }}
            </a>
          </li>
          {% endif %} {% endfor %} {% if page < total_pages %}
          <li class="page-item">
            <a
              class="page-link"
              href="?page={{ page+1 }}{% if selected_profile %}&profile_id={{ selected_profile.id }}{% endif %}"
            >
              <i class="fas fa-chevron-right"></i>
            </a>
          </li>
          {% endif %}
        </ul>
      </nav>
      {% endif %}
    </div>
  </div>

  <!-- Empty State -->
  {% else %}
  <div class="row">
    <div class="col-12">
      <div class="text-center py-5">
        <div class="mb-4">
          <i
            class="fas fa-play-circle fa-4x"
            style="color: var(--text-secondary)"
          ></i>
        </div>
        <h3 class="mb-3" style="color: var(--text-primary)">
          Nothing to Continue Watching
        </h3>
        <p class="text-secondary mb-4">
          {% if selected_profile %} No continue watching items found for the "{{
          selected_profile.name }}" profile. Start watching movies to see them
          here. {% else %} You haven't started watching any movies yet. Start
          exploring our collection to begin your watching journey. {% endif %}
        </p>
        <div class="d-flex gap-3 justify-content-center">
          <a href="{{ url_for('movies_index') }}" class="btn btn-primary">
            <i class="fas fa-film me-2"></i>Browse Movies
          </a>
          {% if selected_profile %}
          <a
            href="{{ url_for('continue_watching') }}"
            class="btn btn-outline-primary"
          >
            <i class="fas fa-users me-2"></i>View All Profiles
          </a>
          {% endif %}
        </div>

        {% if not selected_profile and profiles|length > 1 %}
        <div class="mt-5">
          <h5 class="mb-3">Check other profiles:</h5>
          <div class="d-flex flex-wrap gap-3 justify-content-center">
            {% for profile in profiles %}
            <a
              href="{{ url_for('continue_watching', profile_id=profile.id) }}"
              class="btn btn-outline-primary"
            >
              <i class="fas fa-user me-2"></i>{{ profile.name }}
            </a>
            {% endfor %}
          </div>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Recently Completed Section -->
  {% if recently_completed %}
  <div class="row mt-5">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="h4" style="color: var(--text-primary)">
          <i class="fas fa-check-circle me-2" style="color: var(--success)"></i
          >Recently Completed
        </h3>
        <a href="?completed=true" class="btn btn-outline-primary btn-sm">
          View All <i class="fas fa-arrow-right ms-1"></i>
        </a>
      </div>

      <div class="row">
        {% for item in recently_completed[:4] %}
        <div class="col-md-3 col-lg-2 mb-4">
          <a
            href="{{ url_for('movie_detail', movie_id=item.movie.id) }}"
            class="text-decoration-none"
          >
            <div class="movie-card">
              <div class="position-relative">
                <img
                  src="{{ item.movie.poster_url or 'https://via.placeholder.com/300x450/172a45/8892b0?text=No+Poster' }}"
                  alt="{{ item.movie.title }}"
                  class="img-fluid"
                />
                <div class="position-absolute top-0 end-0 m-2">
                  <span class="badge bg-success">
                    <i class="fas fa-check"></i>
                  </span>
                </div>
              </div>
              <div class="movie-info">
                <h6 class="movie-title">{{ item.movie.title }}</h6>
                <small class="text-secondary">
                  Completed {{ item.updated_at.strftime('%b %d') }}
                </small>
              </div>
            </div>
          </a>
        </div>
        {% endfor %}
      </div>
    </div>
  </div>
  {% endif %}
</div>

<!-- Play Modal -->
<div class="modal fade" id="playModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div
      class="modal-content"
      style="background: var(--card-bg); border-color: var(--border-color)"
    >
      <div class="modal-header">
        <h5 class="modal-title" id="playModalTitle">Play Movie</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
        ></button>
      </div>
      <div class="modal-body">
        <div class="text-center py-4" id="playModalContent">
          <!-- Video player will be loaded here -->
          <div id="videoPlayer"></div>
          <div id="playInstructions" class="mt-3">
            <p class="text-secondary">The video player will appear here.</p>
            <p class="text-secondary small">
              In a production environment, this would be a fully functional
              video player.
            </p>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          Close
        </button>
        <button
          type="button"
          class="btn btn-primary"
          onclick="saveWatchProgress()"
        >
          <i class="fas fa-save me-2"></i>Save Progress
        </button>
      </div>
    </div>
  </div>
</div>

<script>
  // Global variables for video player
  let currentMovieId = null;
  let currentTimestamp = 0;
  let currentDuration = 0;

  function playFromTimestamp(movieId, timestamp) {
    currentMovieId = movieId;
    currentTimestamp = timestamp;

    // Get movie duration from data attribute or use default
    const movieCard = document.querySelector(`[data-movie-id="${movieId}"]`);
    currentDuration = movieCard ? parseInt(movieCard.dataset.duration) : 7200;

    // Update modal title
    document.getElementById("playModalTitle").textContent = "Continue Watching";

    // Show modal
    const modal = new bootstrap.Modal(document.getElementById("playModal"));
    modal.show();

    // Simulate video player (in production, use actual video player)
    const playerContent = `
        <div class="trailer-container mb-3">
            <div class="text-center py-5" style="background: var(--secondary-dark); border-radius: var(--radius);">
                <i class="fas fa-play-circle fa-4x mb-3" style="color: var(--primary-blue);"></i>
                <h5>Video Player Placeholder</h5>
                <p class="text-secondary">Resuming at ${formatTime(
                  timestamp
                )}</p>
                <div class="mt-3">
                    <button class="btn btn-primary" onclick="simulatePlayback()">
                        <i class="fas fa-play me-2"></i>Simulate Playback
                    </button>
                </div>
            </div>
        </div>
        <div class="progress mb-3">
            <div class="progress-bar" role="progressbar" 
                 style="width: ${((timestamp / currentDuration) * 100).toFixed(
                   1
                 )}%">
                ${((timestamp / currentDuration) * 100).toFixed(1)}%
            </div>
        </div>
        <div class="d-flex justify-content-between text-secondary small">
            <span>${formatTime(timestamp)}</span>
            <span>${formatTime(currentDuration)}</span>
        </div>
    `;

    document.getElementById("playModalContent").innerHTML = playerContent;
    document.getElementById("playInstructions").style.display = "none";
  }

  function playFromBeginning(movieId) {
    currentMovieId = movieId;
    currentTimestamp = 0;

    // Get movie duration
    const movieCard = document.querySelector(`[data-movie-id="${movieId}"]`);
    currentDuration = movieCard ? parseInt(movieCard.dataset.duration) : 7200;

    // Update modal title
    document.getElementById("playModalTitle").textContent =
      "Start from Beginning";

    // Show modal
    const modal = new bootstrap.Modal(document.getElementById("playModal"));
    modal.show();

    // Simulate video player
    const playerContent = `
        <div class="trailer-container mb-3">
            <div class="text-center py-5" style="background: var(--secondary-dark); border-radius: var(--radius);">
                <i class="fas fa-play-circle fa-4x mb-3" style="color: var(--primary-blue);"></i>
                <h5>Video Player Placeholder</h5>
                <p class="text-secondary">Starting from beginning</p>
                <div class="mt-3">
                    <button class="btn btn-primary" onclick="simulatePlayback()">
                        <i class="fas fa-play me-2"></i>Simulate Playback
                    </button>
                </div>
            </div>
        </div>
        <div class="progress mb-3">
            <div class="progress-bar" role="progressbar" style="width: 0%">0%</div>
        </div>
        <div class="d-flex justify-content-between text-secondary small">
            <span>0:00</span>
            <span>${formatTime(currentDuration)}</span>
        </div>
    `;

    document.getElementById("playModalContent").innerHTML = playerContent;
    document.getElementById("playInstructions").style.display = "none";
  }

  function simulatePlayback() {
    // Simulate video playback progress
    const progressBar = document.querySelector(
      "#playModalContent .progress-bar"
    );
    let progress = currentTimestamp;

    const interval = setInterval(() => {
      progress += 5; // Simulate 5 seconds of playback
      const percentage = ((progress / currentDuration) * 100).toFixed(1);

      progressBar.style.width = `${percentage}%`;
      progressBar.textContent = `${percentage}%`;

      // Update current timestamp
      currentTimestamp = progress;

      // Stop simulation at the end
      if (progress >= currentDuration) {
        clearInterval(interval);
        progressBar.classList.add("bg-success");
      }
    }, 500);

    // Stop simulation when modal is closed
    const modal = document.getElementById("playModal");
    modal.addEventListener("hidden.bs.modal", () => {
      clearInterval(interval);
    });
  }

  function saveWatchProgress() {
    if (!currentMovieId) return;

    // Save progress to server - FIXED: Include movie_id in the URL
    fetch(`/api/movie/${currentMovieId}/watchtime`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRF-Token": document.querySelector('meta[name="csrf-token"]')
          .content,
      },
      body: JSON.stringify({
        current_time: currentTimestamp,
        duration: currentDuration,
      }),
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          // Show success message
          alert("Progress saved successfully!");

          // Close modal
          const modal = bootstrap.Modal.getInstance(
            document.getElementById("playModal")
          );
          modal.hide();

          // Reload page to show updated progress
          setTimeout(() => location.reload(), 1000);
        } else {
          alert("Failed to save progress. Please try again.");
        }
      })
      .catch((error) => {
        console.error("Error:", error);
        alert("An error occurred while saving progress.");
      });
  }

  function removeFromContinueWatching(itemId) {
    if (confirm("Remove this item from continue watching?")) {
      fetch(`/remove_continue_watching/${itemId}`, {
        method: "DELETE",
        headers: {
          "X-CSRF-Token": document.querySelector('meta[name="csrf-token"]')
            .content,
        },
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.success) {
            // Remove the item from the DOM
            const itemElement = document.querySelector(
              `[data-item-id="${itemId}"]`
            );
            if (itemElement) {
              itemElement.remove();
            }

            // Show success message
            const alertDiv = document.createElement("div");
            alertDiv.className =
              "alert alert-success alert-dismissible fade show";
            alertDiv.innerHTML = `
                    Item removed from continue watching.
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
            document.querySelector(".container").prepend(alertDiv);

            // Reload if no items left
            if (document.querySelectorAll(".movie-card").length === 0) {
              setTimeout(() => location.reload(), 2000);
            }
          }
        })
        .catch((error) => {
          console.error("Error:", error);
          alert("Failed to remove item. Please try again.");
        });
    }
  }

  function formatTime(seconds) {
    const hours = Math.floor(seconds / 3600);
    const minutes = Math.floor((seconds % 3600) / 60);
    const secs = Math.floor(seconds % 60);

    if (hours > 0) {
      return `${hours}:${minutes.toString().padStart(2, "0")}:${secs
        .toString()
        .padStart(2, "0")}`;
    } else {
      return `${minutes}:${secs.toString().padStart(2, "0")}`;
    }
  }
</script>

<!-- Add data attributes to movie cards for JavaScript -->
<script>
  document.addEventListener("DOMContentLoaded", function () {
    // Add data attributes to movie cards
    document.querySelectorAll(".movie-card").forEach((card) => {
      const itemId = card.querySelector("[data-item-id]")?.dataset.itemId;
      const movieId = card
        .querySelector('a[href*="/movie/"]')
        ?.href.split("/")
        .pop();
      const duration =
        card.querySelector("[data-duration]")?.dataset.duration || 7200;

      if (itemId) card.dataset.itemId = itemId;
      if (movieId) card.dataset.movieId = movieId;
      if (duration) card.dataset.duration = duration;
    });
  });
</script>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    // Add data attributes to movie cards
    document.querySelectorAll(".movie-card").forEach((card) => {
      const itemId = card.querySelector("[data-item-id]")?.dataset.itemId;
      const movieId = card
        .querySelector('a[href*="/movie/"]')
        ?.href.split("/")
        .pop();
      const duration =
        card.querySelector("[data-duration]")?.dataset.duration || 7200;

      if (itemId) card.dataset.itemId = itemId;
      if (movieId) card.dataset.movieId = movieId;
      if (duration) card.dataset.duration = duration;
    });
  });
</script>

<style>
  .movie-card {
    transition: transform 0.3s ease, box-shadow 0.3s ease;
  }

  .movie-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 30px -15px rgba(2, 12, 27, 0.7);
  }

  .progress-bar {
    transition: width 0.3s ease;
  }

  .dropdown-menu {
    background-color: var(--card-bg);
    border-color: var(--border-color);
  }

  .dropdown-item {
    color: var(--text-primary);
  }

  .dropdown-item:hover {
    background-color: var(--secondary-dark);
    color: var(--primary-blue);
  }

  .page-link {
    background-color: var(--card-bg);
    border-color: var(--border-color);
    color: var(--text-primary);
  }

  .page-link:hover {
    background-color: var(--secondary-dark);
    border-color: var(--primary-blue);
    color: var(--primary-blue);
  }

  .page-item.active .page-link {
    background-color: var(--primary-blue);
    border-color: var(--primary-blue);
    color: var(--primary-dark);
  }
</style>
{% endblock %}
