{% extends "base.html" %} {% block title %}Manage Movies - Admin{% endblock %}
{% block content %}
<div class="container mt-5 pt-5">
  <!-- Header -->
  <div class="row mb-4">
    <div class="col-12">
      <h1 class="h2" style="color: var(--text-primary)">
        <i class="fas fa-film me-2" style="color: var(--primary-blue)"></i>
        Manage Movies
      </h1>
      <p class="text-secondary">
        Upload, edit, and delete movies. Manage movie files and metadata.
      </p>
    </div>
  </div>

  <!-- Actions Bar -->
  <div class="row mb-4">
    <div class="col-12">
      <div
        class="card"
        style="background: var(--card-bg); border-color: var(--border-color)"
      >
        <div class="card-body">
          <div
            class="d-flex justify-content-between align-items-center flex-wrap gap-3"
          >
            <div class="d-flex gap-2">
              <a
                href="{{ url_for('admin_add_movie') }}"
                class="btn btn-primary"
              >
                <i class="fas fa-plus me-2"></i>Add Movie
              </a>
              <button
                class="btn btn-outline-primary"
                data-bs-toggle="modal"
                data-bs-target="#bulkActionsModal"
              >
                <i class="fas fa-tasks me-2"></i>Bulk Actions
              </button>
            </div>

            <div class="d-flex gap-3">
              <!-- Search Form -->
              <form method="GET" class="d-flex">
                <div class="input-group" style="width: 300px">
                  <input
                    type="text"
                    class="form-control"
                    placeholder="Search movies..."
                    name="search"
                    value="{{ search }}"
                  />
                  <button class="btn btn-outline-primary" type="submit">
                    <i class="fas fa-search"></i>
                  </button>
                </div>
              </form>

              <!-- Sort Dropdown -->
              <div class="dropdown">
                <button
                  class="btn btn-outline-secondary dropdown-toggle"
                  type="button"
                  data-bs-toggle="dropdown"
                >
                  <i class="fas fa-sort me-2"></i>
                  {% if sort == 'newest' %}Newest First {% elif sort == 'oldest'
                  %}Oldest First {% elif sort == 'title_asc' %}Title A-Z {% elif
                  sort == 'title_desc' %}Title Z-A {% elif sort == 'views'
                  %}Most Views {% elif sort == 'downloads' %}Most Downloads {%
                  endif %}
                </button>
                <ul class="dropdown-menu">
                  <li>
                    <a
                      class="dropdown-item"
                      href="?sort=newest{% if search %}&search={{ search }}{% endif %}"
                      >Newest First</a
                    >
                  </li>
                  <li>
                    <a
                      class="dropdown-item"
                      href="?sort=oldest{% if search %}&search={{ search }}{% endif %}"
                      >Oldest First</a
                    >
                  </li>
                  <li><hr class="dropdown-divider" /></li>
                  <li>
                    <a
                      class="dropdown-item"
                      href="?sort=title_asc{% if search %}&search={{ search }}{% endif %}"
                      >Title A-Z</a
                    >
                  </li>
                  <li>
                    <a
                      class="dropdown-item"
                      href="?sort=title_desc{% if search %}&search={{ search }}{% endif %}"
                      >Title Z-A</a
                    >
                  </li>
                  <li><hr class="dropdown-divider" /></li>
                  <li>
                    <a
                      class="dropdown-item"
                      href="?sort=views{% if search %}&search={{ search }}{% endif %}"
                      >Most Views</a
                    >
                  </li>
                  <li>
                    <a
                      class="dropdown-item"
                      href="?sort=downloads{% if search %}&search={{ search }}{% endif %}"
                      >Most Downloads</a
                    >
                  </li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Movies List -->
  <div class="row">
    <div class="col-12">
      <div
        class="card"
        style="background: var(--card-bg); border-color: var(--border-color)"
      >
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-hover" style="color: var(--text-primary)">
              <thead>
                <tr>
                  <th width="50">
                    <input
                      type="checkbox"
                      id="selectAllCheckbox"
                      class="form-check-input"
                    />
                  </th>
                  <th width="100">Poster</th>
                  <th>Movie</th>
                  <th>Year</th>
                  <th>Stats</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for movie in movies %}
                <tr data-movie-id="{{ movie.id }}">
                  <td>
                    <input
                      type="checkbox"
                      class="movie-checkbox form-check-input"
                      value="{{ movie.id }}"
                    />
                  </td>
                  <td>
                    {% if movie.poster_url %}
                    <img
                      src="{{ movie.poster_url }}"
                      alt="{{ movie.title }}"
                      class="rounded"
                      style="width: 60px; height: 90px; object-fit: cover"
                    />
                    {% else %}
                    <div
                      class="rounded d-flex align-items-center justify-content-center"
                      style="
                        width: 60px;
                        height: 90px;
                        background: var(--secondary-dark);
                      "
                    >
                      <i class="fas fa-film text-secondary"></i>
                    </div>
                    {% endif %}
                  </td>
                  <td>
                    <h6 class="mb-1">{{ movie.title }}</h6>
                    <p
                      class="text-secondary small mb-1"
                      style="font-size: 0.85rem"
                    >
                      {{ movie.description[:100] }}{% if
                      movie.description|length > 100 %}...{% endif %}
                    </p>
                    <div class="d-flex flex-wrap gap-1">
                      {% for genre in movie.genres[:3] %}
                      <span class="badge bg-secondary">{{ genre.name }}</span>
                      {% endfor %} {% if movie.genres|length > 3 %}
                      <span class="badge bg-secondary"
                        >+{{ movie.genres|length - 3 }}</span
                      >
                      {% endif %}
                    </div>
                  </td>
                  <td>{{ movie.release_year or 'N/A' }}</td>
                  <td>
                    <div class="d-flex flex-column gap-1">
                      <small>
                        <i class="fas fa-eye me-1"></i>
                        {{ movie.views_count }} views
                      </small>
                      <small>
                        <i class="fas fa-download me-1"></i>
                        {{ movie.download_count }} downloads
                      </small>
                      <small>
                        <i class="fas fa-star me-1"></i>
                        {{ movie.imdb_rating or 'N/A' }} rating
                      </small>
                    </div>
                  </td>
                  <td>
                    <div class="d-flex flex-column gap-1">
                      {% if movie.is_featured %}
                      <span class="badge bg-warning">Featured</span>
                      {% endif %} {% if movie.download_enabled %}
                      <span class="badge bg-success">Download Enabled</span>
                      {% else %}
                      <span class="badge bg-secondary">No Download</span>
                      {% endif %} {% if movie.file_path %}
                      <span class="badge bg-info">Has File</span>
                      {% else %}
                      <span class="badge bg-danger">No File</span>
                      {% endif %}
                    </div>
                  </td>
                  <td>
                    <div class="d-flex gap-2">
                      <a
                        href="{{ url_for('movie_detail', movie_id=movie.id) }}"
                        class="btn btn-sm btn-outline-primary"
                        target="_blank"
                        title="View"
                      >
                        <i class="fas fa-eye"></i>
                      </a>
                      <a
                        href="{{ url_for('admin_edit_movie', movie_id=movie.id) }}"
                        class="btn btn-sm btn-outline-secondary"
                        title="Edit"
                      >
                        <i class="fas fa-edit"></i>
                      </a>
                      {% if not movie.file_path %}
                      <a
                        href="{{ url_for('admin_upload_movie_file', movie_id=movie.id) }}"
                        class="btn btn-sm btn-outline-info"
                        title="Upload File"
                      >
                        <i class="fas fa-upload"></i>
                      </a>
                      {% else %}
                      <button
                        class="btn btn-sm btn-outline-warning"
                        onclick="deleteMovieFile({{ movie.id }})"
                        title="Delete File"
                      >
                        <i class="fas fa-trash-alt"></i>
                      </button>
                      {% endif %}
                      <button
                        class="btn btn-sm btn-outline-danger"
                        onclick="deleteMovie({{ movie.id }})"
                        title="Delete"
                      >
                        <i class="fas fa-trash"></i>
                      </button>
                    </div>
                  </td>
                </tr>
                {% else %}
                <tr>
                  <td colspan="7" class="text-center py-4">
                    <i
                      class="fas fa-film fa-3x mb-3"
                      style="color: var(--text-secondary)"
                    ></i>
                    <h5 class="text-secondary">No movies found</h5>
                    <p class="text-secondary mb-0">
                      {% if search %} No results for "{{ search }}" {% else %}
                      Start by adding your first movie {% endif %}
                    </p>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>

          <!-- Pagination -->
          {% if pagination.pages > 1 %}
          <nav aria-label="Page navigation" class="mt-4">
            <ul class="pagination justify-content-center">
              {% if pagination.has_prev %}
              <li class="page-item">
                <a
                  class="page-link"
                  href="?page={{ pagination.prev_num }}{% if search %}&search={{ search }}{% endif %}{% if sort %}&sort={{ sort }}{% endif %}"
                >
                  Previous
                </a>
              </li>
              {% endif %} {% for page_num in pagination.iter_pages(left_edge=2,
              left_current=2, right_current=3, right_edge=2) %} {% if page_num
              %} {% if page_num == pagination.page %}
              <li class="page-item active">
                <span class="page-link">{{ page_num }}</span>
              </li>
              {% else %}
              <li class="page-item">
                <a
                  class="page-link"
                  href="?page={{ page_num }}{% if search %}&search={{ search }}{% endif %}{% if sort %}&sort={{ sort }}{% endif %}"
                >
                  {{ page_num }}
                </a>
              </li>
              {% endif %} {% else %}
              <li class="page-item disabled">
                <span class="page-link">...</span>
              </li>
              {% endif %} {% endfor %} {% if pagination.has_next %}
              <li class="page-item">
                <a
                  class="page-link"
                  href="?page={{ pagination.next_num }}{% if search %}&search={{ search }}{% endif %}{% if sort %}&sort={{ sort }}{% endif %}"
                >
                  Next
                </a>
              </li>
              {% endif %}
            </ul>
          </nav>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Bulk Actions Modal -->
<div class="modal fade" id="bulkActionsModal" tabindex="-1">
  <div class="modal-dialog">
    <div
      class="modal-content"
      style="background: var(--card-bg); border-color: var(--border-color)"
    >
      <div class="modal-header">
        <h5 class="modal-title">Bulk Actions</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
        ></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label">Select Action:</label>
          <select class="form-control" id="bulkActionSelect">
            <option value="">-- Select Action --</option>
            <option value="delete">Delete Selected Movies</option>
            <option value="feature">Mark as Featured</option>
            <option value="unfeature">Remove from Featured</option>
            <option value="enable_download">Enable Downloads</option>
            <option value="disable_download">Disable Downloads</option>
          </select>
        </div>
        <div
          class="alert alert-warning"
          id="bulkActionWarning"
          style="display: none"
        >
          <i class="fas fa-exclamation-triangle me-2"></i>
          <span id="warningText"></span>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          Cancel
        </button>
        <button
          type="button"
          class="btn btn-danger"
          id="confirmBulkAction"
          disabled
        >
          Confirm
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
  <div class="modal-dialog">
    <div
      class="modal-content"
      style="background: var(--card-bg); border-color: var(--border-color)"
    >
      <div class="modal-header">
        <h5 class="modal-title">Confirm Delete</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
        ></button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to delete this movie?</p>
        <p class="text-danger small">
          <i class="fas fa-exclamation-triangle me-1"></i>
          This action cannot be undone. All reviews, watchlist entries, and
          download records will be deleted.
        </p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          Cancel
        </button>
        <button type="button" class="btn btn-danger" id="confirmDelete">
          Delete
        </button>
      </div>
    </div>
  </div>
</div>

<style>
  .table th {
    border-color: var(--border-color) !important;
    background: var(--secondary-dark);
    font-weight: 600;
  }

  .table td {
    border-color: var(--border-color) !important;
    vertical-align: middle;
  }

  .table tr:hover {
    background: rgba(var(--primary-blue-rgb), 0.05);
  }

  .page-link {
    background: var(--card-bg);
    border-color: var(--border-color);
    color: var(--text-primary);
  }

  .page-link:hover {
    background: var(--secondary-dark);
    border-color: var(--primary-blue);
    color: var(--primary-blue);
  }

  .page-item.active .page-link {
    background: var(--primary-blue);
    border-color: var(--primary-blue);
    color: white;
  }

  .dropdown-menu {
    background: var(--card-bg);
    border-color: var(--border-color);
  }

  .dropdown-item {
    color: var(--text-primary);
  }

  .dropdown-item:hover {
    background: var(--secondary-dark);
    color: var(--text-primary);
  }
</style>

<script>
  let movieToDelete = null;
  let selectedMovieIds = new Set();

  // Select All Checkbox
  document
    .getElementById("selectAllCheckbox")
    ?.addEventListener("change", function (e) {
      const checkboxes = document.querySelectorAll(".movie-checkbox");
      checkboxes.forEach((checkbox) => {
        checkbox.checked = e.target.checked;
        if (e.target.checked) {
          selectedMovieIds.add(parseInt(checkbox.value));
        } else {
          selectedMovieIds.delete(parseInt(checkbox.value));
        }
      });
      updateBulkActionButton();
    });

  // Individual Checkboxes
  document.querySelectorAll(".movie-checkbox").forEach((checkbox) => {
    checkbox.addEventListener("change", function () {
      const movieId = parseInt(this.value);
      if (this.checked) {
        selectedMovieIds.add(movieId);
      } else {
        selectedMovieIds.delete(movieId);
        document.getElementById("selectAllCheckbox").checked = false;
      }
      updateBulkActionButton();
    });
  });

  // Bulk Action Handler
  document
    .getElementById("bulkActionSelect")
    ?.addEventListener("change", function () {
      const action = this.value;
      const warning = document.getElementById("bulkActionWarning");
      const warningText = document.getElementById("warningText");
      const confirmBtn = document.getElementById("confirmBulkAction");

      if (!action) {
        warning.style.display = "none";
        confirmBtn.disabled = true;
        confirmBtn.className = "btn btn-danger";
        return;
      }

      let message = "";
      let btnClass = "btn btn-danger";

      switch (action) {
        case "delete":
          message = `This will delete ${selectedMovieIds.size} movie(s) permanently. All associated data will be lost.`;
          break;
        case "feature":
          message = `Mark ${selectedMovieIds.size} movie(s) as featured.`;
          btnClass = "btn btn-warning";
          break;
        case "unfeature":
          message = `Remove ${selectedMovieIds.size} movie(s) from featured.`;
          btnClass = "btn btn-warning";
          break;
        case "enable_download":
          message = `Enable downloads for ${selectedMovieIds.size} movie(s).`;
          btnClass = "btn btn-success";
          break;
        case "disable_download":
          message = `Disable downloads for ${selectedMovieIds.size} movie(s).`;
          btnClass = "btn btn-secondary";
          break;
      }

      warningText.textContent = message;
      warning.style.display = "block";
      confirmBtn.disabled = false;
      confirmBtn.className = btnClass;
    });

  // Confirm Bulk Action
  document
    .getElementById("confirmBulkAction")
    ?.addEventListener("click", async function () {
      const action = document.getElementById("bulkActionSelect").value;
      const movieIds = Array.from(selectedMovieIds);

      if (!action || movieIds.length === 0) return;

      try {
        const response = await fetch("/admin/movies/bulk-actions", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRF-Token": "{{ csrf_token() }}",
          },
          body: JSON.stringify({ action, movie_ids: movieIds }),
        });

        const data = await response.json();

        if (data.success) {
          location.reload();
        } else {
          alert("Error: " + data.error);
        }
      } catch (error) {
        alert("Error performing bulk action: " + error.message);
      }
    });

  // Delete Movie
  function deleteMovie(movieId) {
    movieToDelete = movieId;
    const deleteModal = new bootstrap.Modal(
      document.getElementById("deleteModal")
    );
    deleteModal.show();
  }

  document
    .getElementById("confirmDelete")
    ?.addEventListener("click", async function () {
      if (!movieToDelete) return;

      try {
        const response = await fetch(`/admin/movies/${movieToDelete}/delete`, {
          method: "POST",
          headers: {
            "X-CSRF-Token": "{{ csrf_token() }}",
          },
        });

        const data = await response.json();

        if (data.success) {
          location.reload();
        } else {
          alert("Error: " + data.error);
        }
      } catch (error) {
        alert("Error deleting movie: " + error.message);
      }
    });

  // Delete Movie File
  async function deleteMovieFile(movieId) {
    if (
      !confirm(
        "Are you sure you want to delete the movie file? This will disable downloads for this movie."
      )
    ) {
      return;
    }

    try {
      const response = await fetch(`/admin/movies/${movieId}/delete-file`, {
        method: "POST",
        headers: {
          "X-CSRF-Token": "{{ csrf_token() }}",
        },
      });

      if (response.ok) {
        location.reload();
      } else {
        const data = await response.json();
        alert("Error: " + (data.error || "Unknown error"));
      }
    } catch (error) {
      alert("Error deleting file: " + error.message);
    }
  }

  function updateBulkActionButton() {
    const selectAllCheckbox = document.getElementById("selectAllCheckbox");
    const checkboxes = document.querySelectorAll(".movie-checkbox");
    const allChecked =
      checkboxes.length > 0 && Array.from(checkboxes).every((cb) => cb.checked);

    if (selectAllCheckbox) {
      selectAllCheckbox.checked = allChecked;
      selectAllCheckbox.indeterminate =
        !allChecked && selectedMovieIds.size > 0;
    }
  }

  // Initialize
  document.addEventListener("DOMContentLoaded", function () {
    updateBulkActionButton();
  });
</script>
{% endblock %}
