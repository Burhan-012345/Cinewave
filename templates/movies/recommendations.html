{% extends "base.html" %} {% block title %}Recommendations - CineWave{% endblock
%} {% block head %}
<style>
  /* Recommendations Page Styles */
  .recommendations-header {
    background: linear-gradient(
      135deg,
      rgba(37, 99, 235, 0.1),
      rgba(139, 92, 246, 0.1)
    );
    border-radius: 12px;
    padding: 2rem;
    margin-bottom: 2rem;
    border: 1px solid var(--border-color);
  }

  .recommendations-title {
    color: var(--primary-blue);
    font-weight: 700;
    margin-bottom: 0.5rem;
  }

  .recommendations-subtitle {
    color: var(--text-secondary);
    font-size: 1.1rem;
  }

  .algorithm-info {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 1.5rem;
    margin-bottom: 2rem;
  }

  .algorithm-info h4 {
    color: var(--primary-blue);
    margin-bottom: 0.75rem;
    font-weight: 600;
  }

  .algorithm-info p {
    color: var(--text-secondary);
    margin-bottom: 0.5rem;
  }

  .algorithm-info ul {
    padding-left: 1.5rem;
    margin-bottom: 0;
  }

  .algorithm-info li {
    color: var(--text-secondary);
    margin-bottom: 0.25rem;
  }

  .recommendation-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
  }

  .recommendation-card {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    overflow: hidden;
    transition: all 0.3s ease;
    height: 100%;
  }

  .recommendation-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    border-color: var(--primary-blue);
  }

  .recommendation-poster {
    position: relative;
    height: 200px;
    overflow: hidden;
  }

  .recommendation-poster img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.5s ease;
  }

  .recommendation-card:hover .recommendation-poster img {
    transform: scale(1.05);
  }

  .recommendation-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(to bottom, transparent 60%, rgba(0, 0, 0, 0.8));
    display: flex;
    align-items: flex-end;
    padding: 1rem;
  }

  .recommendation-match {
    background: var(--primary-blue);
    color: white;
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.875rem;
    font-weight: 600;
  }

  .recommendation-content {
    padding: 1.25rem;
  }

  .recommendation-title {
    color: var(--text-primary);
    font-weight: 600;
    margin-bottom: 0.5rem;
    font-size: 1.1rem;
    line-height: 1.3;
  }

  .recommendation-meta {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 0.75rem;
    color: var(--text-secondary);
    font-size: 0.875rem;
  }

  .recommendation-rating {
    display: flex;
    align-items: center;
    gap: 0.25rem;
    color: #ffc107;
  }

  .recommendation-genres {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-bottom: 1rem;
  }

  .genre-tag {
    background: var(--secondary-dark);
    color: var(--text-secondary);
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.75rem;
    border: 1px solid var(--border-color);
  }

  .recommendation-reason {
    color: var(--text-secondary);
    font-size: 0.875rem;
    line-height: 1.4;
    margin-bottom: 1rem;
    padding: 0.75rem;
    background: var(--secondary-dark);
    border-radius: 8px;
    border-left: 3px solid var(--primary-blue);
  }

  .recommendation-reason .reason-label {
    color: var(--primary-blue);
    font-weight: 600;
    margin-bottom: 0.25rem;
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .recommendation-actions {
    display: flex;
    gap: 0.75rem;
  }

  .btn-sm {
    padding: 0.375rem 0.75rem;
    font-size: 0.875rem;
  }

  /* Empty State */
  .empty-recommendations {
    text-align: center;
    padding: 3rem;
    background: var(--card-bg);
    border: 2px dashed var(--border-color);
    border-radius: 12px;
    margin: 2rem 0;
  }

  .empty-recommendations i {
    font-size: 3rem;
    color: var(--text-muted);
    margin-bottom: 1rem;
  }

  .empty-recommendations h4 {
    color: var(--text-primary);
    margin-bottom: 0.5rem;
  }

  .empty-recommendations p {
    color: var(--text-secondary);
    margin-bottom: 1.5rem;
  }

  /* Filters */
  .recommendation-filters {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 2rem;
  }

  .filter-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
  }

  .filter-header h4 {
    color: var(--text-primary);
    margin: 0;
    font-weight: 600;
  }

  .filter-options {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
  }

  .filter-group {
    flex: 1;
    min-width: 200px;
  }

  .filter-group label {
    display: block;
    color: var(--text-secondary);
    font-size: 0.875rem;
    margin-bottom: 0.5rem;
    font-weight: 500;
  }

  .form-select {
    width: 100%;
    padding: 0.5rem 1rem;
    background: var(--secondary-dark);
    border: 1px solid var(--border-color);
    border-radius: 6px;
    color: var(--text-primary);
    font-size: 0.875rem;
  }

  .form-select:focus {
    outline: none;
    border-color: var(--primary-blue);
    box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
  }

  /* Refresh Button */
  .refresh-btn {
    position: fixed;
    bottom: 2rem;
    right: 2rem;
    z-index: 1000;
  }

  .refresh-btn .btn {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    border-radius: 50%;
    width: 60px;
    height: 60px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  /* Loading State */
  .loading-recommendations {
    text-align: center;
    padding: 4rem 0;
  }

  .loading-recommendations .spinner-border {
    width: 3rem;
    height: 3rem;
    color: var(--primary-blue);
  }

  /* Responsive */
  @media (max-width: 768px) {
    .recommendation-grid {
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 1rem;
    }

    .recommendations-header {
      padding: 1.5rem;
    }

    .algorithm-info {
      padding: 1rem;
    }

    .filter-options {
      flex-direction: column;
      gap: 0.75rem;
    }

    .filter-group {
      min-width: 100%;
    }

    .refresh-btn {
      bottom: 1rem;
      right: 1rem;
    }

    .refresh-btn .btn {
      width: 50px;
      height: 50px;
    }
  }

  @media (max-width: 576px) {
    .recommendation-grid {
      grid-template-columns: 1fr;
    }

    .recommendation-actions {
      flex-direction: column;
    }

    .recommendation-actions .btn {
      width: 100%;
    }
  }
</style>
{% endblock %} {% block content %}
<div class="container py-4">
  <!-- Header -->
  <div class="recommendations-header">
    <h1 class="recommendations-title">
      <i class="fas fa-star me-2"></i>Your Personal Recommendations
    </h1>
    <p class="recommendations-subtitle">
      Movies handpicked just for you based on your watch history, preferences,
      and ratings
    </p>
  </div>

  <!-- Algorithm Info -->
  <div class="algorithm-info">
    <h4><i class="fas fa-brain me-2"></i>How We Recommend Movies</h4>
    <p>
      Our recommendation algorithm analyzes various factors to suggest movies
      you'll love:
    </p>
    <ul>
      <li>Your watch history and viewing patterns</li>
      <li>Movies you've rated highly</li>
      <li>Your watchlist and saved content</li>
      <li>Similar users' preferences</li>
      <li>Current trending movies in your favorite genres</li>
    </ul>
  </div>

  <!-- Filters -->
  <div class="recommendation-filters">
    <div class="filter-header">
      <h4><i class="fas fa-filter me-2"></i>Filter Recommendations</h4>
      <button class="btn btn-sm btn-outline-secondary" onclick="resetFilters()">
        <i class="fas fa-redo me-1"></i>Reset
      </button>
    </div>
    <div class="filter-options">
      <div class="filter-group">
        <label for="genreFilter"><i class="fas fa-tags me-1"></i>Genre</label>
        <select
          id="genreFilter"
          class="form-select"
          onchange="filterRecommendations()"
        >
          <option value="">All Genres</option>
          <option value="action">Action</option>
          <option value="comedy">Comedy</option>
          <option value="drama">Drama</option>
          <option value="scifi">Sci-Fi</option>
          <option value="horror">Horror</option>
          <option value="romance">Romance</option>
          <option value="thriller">Thriller</option>
        </select>
      </div>
      <div class="filter-group">
        <label for="ratingFilter"
          ><i class="fas fa-star me-1"></i>Minimum Rating</label
        >
        <select
          id="ratingFilter"
          class="form-select"
          onchange="filterRecommendations()"
        >
          <option value="0">Any Rating</option>
          <option value="7">7+ IMDB</option>
          <option value="8">8+ IMDB</option>
          <option value="9">9+ IMDB</option>
        </select>
      </div>
      <div class="filter-group">
        <label for="yearFilter"
          ><i class="fas fa-calendar me-1"></i>Release Year</label
        >
        <select
          id="yearFilter"
          class="form-select"
          onchange="filterRecommendations()"
        >
          <option value="">Any Year</option>
          <option value="2024">2024</option>
          <option value="2023">2023</option>
          <option value="2022">2022</option>
          <option value="2021">2021</option>
          <option value="2020">2020</option>
        </select>
      </div>
      <div class="filter-group">
        <label for="matchFilter"
          ><i class="fas fa-percentage me-1"></i>Match Score</label
        >
        <select
          id="matchFilter"
          class="form-select"
          onchange="filterRecommendations()"
        >
          <option value="0">Any Match</option>
          <option value="70">70%+ Match</option>
          <option value="80">80%+ Match</option>
          <option value="90">90%+ Match</option>
        </select>
      </div>
    </div>
  </div>

  {% if movies %}
  <!-- Recommendations Grid -->
  <div class="recommendation-grid" id="recommendationsGrid">
    {% for movie in movies %}
    <!-- In the recommendation card loop, replace the data-genres line with: -->
    <div
      class="recommendation-card"
      data-genres="{% if movie.genres %}{% set genre_list = [] %}{% for genre in movie.genres if genre and genre.name %}{% set _ = genre_list.append(genre.name.lower()) %}{% endfor %}{{ genre_list|join(',') }}{% endif %}"
      data-rating="{{ movie.imdb_rating or 0 }}"
      data-year="{{ movie.release_year or 0 }}"
      data-match="{{ [80 + loop.index * 2, 98] | min }}"
    >
      <div class="recommendation-poster">
        <img
          src="{{ movie.poster_url or url_for('static', filename='images/movie-placeholder.jpg') }}"
          alt="{{ movie.title }} poster"
          loading="lazy"
        />
        <div class="recommendation-overlay">
          <span class="recommendation-match">
            {{ [80 + loop.index * 2, 98] | min }}% Match
          </span>
        </div>
      </div>
      <div class="recommendation-content">
        <h3 class="recommendation-title">
          {{ movie.title }} ({{ movie.release_year }})
        </h3>

        <div class="recommendation-meta">
          <span class="recommendation-rating">
            <i class="fas fa-star"></i>
            {{ movie.imdb_rating or 'N/A' }}
          </span>
          <span
            ><i class="fas fa-clock me-1"></i>{{ movie.duration or 120 }}
            min</span
          >
          <span
            ><i class="fas fa-eye me-1"></i>{{ movie.views_count or 0 }}
            views</span
          >
        </div>

        <div class="recommendation-genres">
          {% if movie.genres %} {% set counter = 0 %} {% for genre in
          movie.genres %} {% if genre and genre.name and counter < 3 %}
          <span class="genre-tag">{{ genre.name }}</span>
          {% set counter = counter + 1 %} {% endif %} {% endfor %} {% if counter
          == 0 %}
          <span class="genre-tag">Uncategorized</span>
          {% endif %} {% else %}
          <span class="genre-tag">Uncategorized</span>
          {% endif %}
        </div>

        <div class="recommendation-reason">
          <div class="reason-label">Why You Might Like This</div>
          {% if loop.index <= 3 %} {% if movie.genres and movie.genres|length >
          0 %} {% set first_genre = movie.genres|first %} Based on your high
          ratings of similar {{ first_genre.name if first_genre and
          first_genre.name else 'action' }} movies {% else %} Based on your high
          ratings of similar action movies {% endif %} {% elif loop.index <= 6
          %} Trending among users with similar watch history {% else %}
          Recommended because you've watched similar content recently {% endif
          %}
        </div>

        <div class="recommendation-actions">
          <a
            href="{{ url_for('movie_detail', movie_id=movie.id) }}"
            class="btn btn-primary btn-sm flex-grow-1"
          >
            <i class="fas fa-play me-1"></i>Watch Now
          </a>
          <a
            href="{{ url_for('request_movie_download', movie_id=movie.id) }}"
            class="btn btn-outline-primary btn-sm"
            title="Download"
          >
            <i class="fas fa-download"></i>
          </a>
          {% if current_user.is_authenticated %} {% set in_watchlist = movie.id
          in watchlist_movie_ids %}
          <button
            class="btn btn-outline-secondary btn-sm watchlist-btn"
            data-movie-id="{{ movie.id }}"
            onclick="toggleWatchlist(this)"
          >
            <i
              class="fas {% if in_watchlist %}fa-check{% else %}fa-plus{% endif %}"
            ></i>
          </button>
          {% endif %}
        </div>
      </div>
    </div>
    {% endfor %}
  </div>

  <!-- No Results Message (Hidden by default) -->
  <div id="noResults" class="empty-recommendations" style="display: none">
    <i class="fas fa-search"></i>
    <h4>No Matching Recommendations</h4>
    <p>Try adjusting your filters to see more recommendations.</p>
    <button class="btn btn-primary" onclick="resetFilters()">
      <i class="fas fa-redo me-1"></i>Reset Filters
    </button>
  </div>
  {% else %}
  <!-- Empty State for No Recommendations -->
  <div class="empty-recommendations">
    <i class="fas fa-film"></i>
    <h4>No Recommendations Yet</h4>
    <p>
      Start watching movies and rating them to get personalized recommendations!
    </p>
    <div class="d-flex gap-2 justify-content-center">
      <a href="{{ url_for('movies_index') }}" class="btn btn-primary">
        <i class="fas fa-film me-1"></i>Browse Movies
      </a>
      <a href="{{ url_for('search') }}" class="btn btn-outline-primary">
        <i class="fas fa-search me-1"></i>Search Movies
      </a>
    </div>
  </div>
  {% endif %}

  <!-- Refresh Recommendations Button -->
  <div class="refresh-btn">
    <button
      class="btn btn-primary btn-lg rounded-circle"
      onclick="refreshRecommendations()"
      title="Refresh Recommendations"
    >
      <i class="fas fa-redo"></i>
    </button>
  </div>
</div>
{% endblock %} {% block scripts %}
<script>
  // Watchlist functionality
  function toggleWatchlist(button) {
    const movieId = button.dataset.movieId;
    const icon = button.querySelector("i");

    // Toggle visual state immediately for better UX
    const isAdding = !icon.classList.contains("fa-check");
    icon.classList.toggle("fa-check", isAdding);
    icon.classList.toggle("fa-plus", !isAdding);

    if (isAdding) {
      button.classList.add("btn-success");
      button.classList.remove("btn-outline-secondary");
    } else {
      button.classList.remove("btn-success");
      button.classList.add("btn-outline-secondary");
    }

    // Make API call
    fetch(`/api/watchlist/${movieId}/toggle`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": "{{ csrf_token() }}",
      },
    })
      .then((response) => response.json())
      .then((data) => {
        if (!data.success) {
          // Revert visual state if API call failed
          icon.classList.toggle("fa-check", !isAdding);
          icon.classList.toggle("fa-plus", isAdding);

          if (!isAdding) {
            button.classList.remove("btn-success");
            button.classList.add("btn-outline-secondary");
          }

          alert(data.error || "Failed to update watchlist");
        } else {
          // Show success message
          const toast = document.createElement("div");
          toast.className = "position-fixed bottom-0 end-0 p-3";
          toast.innerHTML = `
                    <div class="toast show" role="alert">
                        <div class="toast-header">
                            <strong class="me-auto">${
                              isAdding ? "Added to" : "Removed from"
                            } Watchlist</strong>
                            <button type="button" class="btn-close" onclick="this.parentElement.parentElement.remove()"></button>
                        </div>
                        <div class="toast-body">
                            Movie ${
                              isAdding ? "added to" : "removed from"
                            } your watchlist successfully.
                        </div>
                    </div>
                `;
          document.body.appendChild(toast);
          setTimeout(() => toast.remove(), 3000);
        }
      })
      .catch((error) => {
        console.error("Error:", error);
        // Revert visual state
        icon.classList.toggle("fa-check", !isAdding);
        icon.classList.toggle("fa-plus", isAdding);
        alert("An error occurred. Please try again.");
      });
  }

  // Filter recommendations
  function filterRecommendations() {
    const genreFilter = document
      .getElementById("genreFilter")
      .value.toLowerCase();
    const ratingFilter =
      parseFloat(document.getElementById("ratingFilter").value) || 0;
    const yearFilter = document.getElementById("yearFilter").value;
    const matchFilter =
      parseFloat(document.getElementById("matchFilter").value) || 0;

    const recommendationCards = document.querySelectorAll(
      ".recommendation-card"
    );
    let visibleCount = 0;

    recommendationCards.forEach((card) => {
      const genres = card.dataset.genres || "";
      const rating = parseFloat(card.dataset.rating) || 0;
      const year = card.dataset.year || "";
      const match = parseFloat(card.dataset.match) || 0;

      let showCard = true;

      // Apply filters
      if (genreFilter && !genres.includes(genreFilter)) {
        showCard = false;
      }

      if (ratingFilter > 0 && rating < ratingFilter) {
        showCard = false;
      }

      if (yearFilter && year !== yearFilter) {
        showCard = false;
      }

      if (matchFilter > 0 && match < matchFilter) {
        showCard = false;
      }

      if (showCard) {
        card.style.display = "block";
        visibleCount++;
      } else {
        card.style.display = "none";
      }
    });

    // Show/hide no results message
    const noResults = document.getElementById("noResults");
    if (noResults) {
      if (visibleCount === 0 && recommendationCards.length > 0) {
        noResults.style.display = "block";
      } else {
        noResults.style.display = "none";
      }
    }
  }

  // Reset filters
  function resetFilters() {
    document.getElementById("genreFilter").value = "";
    document.getElementById("ratingFilter").value = "0";
    document.getElementById("yearFilter").value = "";
    document.getElementById("matchFilter").value = "0";
    filterRecommendations();
  }

  // Refresh recommendations
  function refreshRecommendations() {
    const refreshBtn = document.querySelector(".refresh-btn .btn");
    const originalHTML = refreshBtn.innerHTML;

    // Show loading state
    refreshBtn.disabled = true;
    refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

    // Add a subtle animation to cards
    const cards = document.querySelectorAll(".recommendation-card");
    cards.forEach((card) => {
      card.style.opacity = "0.5";
      card.style.transform = "scale(0.98)";
    });

    // Simulate API call (you would replace this with actual API call)
    setTimeout(() => {
      // Reload the page to get new recommendations
      window.location.reload();
    }, 1500);

    // Revert button state after 2 seconds if page doesn't reload
    setTimeout(() => {
      refreshBtn.disabled = false;
      refreshBtn.innerHTML = originalHTML;
      cards.forEach((card) => {
        card.style.opacity = "1";
        card.style.transform = "scale(1)";
      });
    }, 2000);
  }

  // Initialize filters on page load
  document.addEventListener("DOMContentLoaded", function () {
    // Check if we have filters in URL
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.has("genre")) {
      document.getElementById("genreFilter").value = urlParams.get("genre");
    }
    if (urlParams.has("min_rating")) {
      document.getElementById("ratingFilter").value =
        urlParams.get("min_rating");
    }
    if (urlParams.has("year")) {
      document.getElementById("yearFilter").value = urlParams.get("year");
    }

    // Apply filters on page load
    filterRecommendations();

    // Add keyboard shortcuts
    document.addEventListener("keydown", function (e) {
      // Ctrl/Cmd + R to refresh
      if ((e.ctrlKey || e.metaKey) && e.key === "r") {
        e.preventDefault();
        refreshRecommendations();
      }
      // Escape to reset filters
      if (e.key === "Escape") {
        resetFilters();
      }
    });
  });

  // Add scroll animation for cards
  const observerOptions = {
    threshold: 0.1,
    rootMargin: "0px 0px -50px 0px",
  };

  const observer = new IntersectionObserver((entries) => {
    entries.forEach((entry) => {
      if (entry.isIntersecting) {
        entry.target.style.opacity = "1";
        entry.target.style.transform = "translateY(0)";
      }
    });
  }, observerOptions);

  // Apply animations to cards on load
  document.addEventListener("DOMContentLoaded", function () {
    const cards = document.querySelectorAll(".recommendation-card");
    cards.forEach((card, index) => {
      card.style.opacity = "0";
      card.style.transform = "translateY(20px)";
      card.style.transition = "opacity 0.5s ease, transform 0.5s ease";
      card.style.transitionDelay = `${index * 0.05}s`;

      setTimeout(() => {
        observer.observe(card);
      }, 100);
    });
  });
</script>
{% endblock %}
