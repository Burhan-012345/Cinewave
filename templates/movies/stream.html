{% extends "base.html" %} {% block title %}Stream {{ movie.title }} - CineWave{%
endblock %} {% block head %}
<!-- Video.js for video player -->
<link href="https://vjs.zencdn.net/8.6.1/video-js.css" rel="stylesheet" />
<link
  rel="stylesheet"
  href="https://cdn.jsdelivr.net/npm/videojs-seek-buttons/dist/videojs-seek-buttons.css"
/>

<style>
  /* Video player custom styles */
  .video-container {
    max-width: 1200px;
    margin: 0 auto;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
    background: var(--card-bg);
    position: relative;
  }

  .video-js {
    width: 100%;
    height: auto;
    aspect-ratio: 16/9;
    background-color: #000;
  }

  .video-js .vjs-big-play-button {
    background-color: rgba(var(--primary-blue-rgb), 0.8);
    border: none;
    width: 80px;
    height: 80px;
    border-radius: 50%;
    line-height: 80px;
    left: 50%;
    top: 50%;
    transform: translate(-50%, -50%);
    transition: all 0.3s ease;
  }

  .video-js .vjs-big-play-button:hover {
    background-color: rgba(var(--primary-blue-rgb), 1);
    transform: translate(-50%, -50%) scale(1.1);
  }

  .video-js .vjs-control-bar {
    background: linear-gradient(to top, rgba(0, 0, 0, 0.8), transparent);
  }

  .video-js .vjs-play-progress,
  .video-js .vjs-volume-level {
    background-color: var(--primary-blue);
  }

  .video-js .vjs-slider {
    background-color: rgba(255, 255, 255, 0.2);
  }

  /* Video error message */
  .video-error {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    text-align: center;
    color: white;
    z-index: 100;
    background: rgba(0, 0, 0, 0.8);
    padding: 2rem;
    border-radius: 10px;
    max-width: 80%;
  }

  /* Movie info section */
  .movie-meta {
    display: flex;
    align-items: center;
    gap: 1rem;
    flex-wrap: wrap;
    margin-bottom: 1.5rem;
  }

  .meta-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: var(--text-secondary);
    font-size: 0.9rem;
  }

  .meta-item i {
    color: var(--primary-blue);
  }

  /* Quality selector */
  .quality-selector {
    display: flex;
    gap: 0.5rem;
    margin-top: 1rem;
    flex-wrap: wrap;
  }

  .quality-btn {
    padding: 0.25rem 0.75rem;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    background: transparent;
    color: var(--text-secondary);
    font-size: 0.8rem;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .quality-btn:hover {
    border-color: var(--primary-blue);
    color: var(--primary-blue);
  }

  .quality-btn.active {
    background: var(--primary-blue);
    border-color: var(--primary-blue);
    color: var(--primary-dark);
  }

  /* Playback controls */
  .playback-controls {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-top: 1.5rem;
    padding: 1rem;
    background: var(--card-bg);
    border-radius: 8px;
    border: 1px solid var(--border-color);
    flex-wrap: wrap;
  }

  .speed-selector {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .speed-selector select {
    background: var(--secondary-dark);
    border: 1px solid var(--border-color);
    color: var(--text-primary);
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
  }

  /* Subtitles */
  .subtitles-selector {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  /* Keyboard shortcuts help */
  .keyboard-shortcuts {
    margin-top: 1rem;
    padding: 0.75rem;
    background: var(--secondary-dark);
    border-radius: 6px;
    border-left: 3px solid var(--primary-blue);
  }

  .shortcut-item {
    display: flex;
    justify-content: space-between;
    margin-bottom: 0.25rem;
    font-size: 0.85rem;
  }

  /* Loading overlay */
  .loading-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    z-index: 1000;
    color: white;
  }

  .spinner {
    width: 50px;
    height: 50px;
    border: 5px solid rgba(255, 255, 255, 0.3);
    border-radius: 50%;
    border-top-color: var(--primary-blue);
    animation: spin 1s ease-in-out infinite;
    margin-bottom: 1rem;
  }

  @keyframes spin {
    to {
      transform: rotate(360deg);
    }
  }

  /* Movie details section */
  .movie-details-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-top: 1.5rem;
  }

  .detail-card {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 1rem;
  }

  .detail-card h6 {
    color: var(--primary-blue);
    margin-bottom: 0.5rem;
    font-size: 0.9rem;
  }

  .detail-card p {
    margin: 0;
    font-size: 0.9rem;
  }

  /* No content placeholder */
  .no-content-placeholder {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    aspect-ratio: 16/9;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    color: white;
    text-align: center;
    padding: 2rem;
  }

  .no-content-placeholder i {
    font-size: 4rem;
    margin-bottom: 1rem;
    opacity: 0.8;
  }

  /* Action buttons */
  .action-buttons {
    display: flex;
    gap: 1rem;
    margin-top: 2rem;
    flex-wrap: wrap;
    justify-content: center;
  }

  /* Mobile responsive */
  @media (max-width: 768px) {
    .video-container {
      border-radius: 0;
      margin: -1rem;
      width: calc(100% + 2rem);
    }

    .playback-controls {
      flex-wrap: wrap;
      gap: 0.75rem;
    }

    .video-js .vjs-big-play-button {
      width: 60px;
      height: 60px;
      line-height: 60px;
    }

    .movie-meta {
      gap: 0.5rem;
    }

    .meta-item {
      font-size: 0.8rem;
    }

    .movie-details-grid {
      grid-template-columns: 1fr;
    }

    .action-buttons {
      flex-direction: column;
      width: 100%;
    }

    .action-buttons .btn {
      width: 100%;
      margin-bottom: 0.5rem;
    }
  }

  @media (max-width: 576px) {
    .playback-controls {
      flex-direction: column;
      align-items: flex-start;
    }

    .speed-selector,
    .subtitles-selector {
      width: 100%;
      justify-content: space-between;
    }
  }
</style>
{% endblock %} {% block content %}
<div class="container py-5 mt-4">
  <!-- Breadcrumb -->
  <nav aria-label="breadcrumb" class="mb-4">
    <ol class="breadcrumb">
      <li class="breadcrumb-item">
        <a href="{{ url_for('movies_index') }}">Movies</a>
      </li>
      <li class="breadcrumb-item">
        <a href="{{ url_for('movie_detail', movie_id=movie.id) }}"
          >{{ movie.title }}</a
        >
      </li>
      <li class="breadcrumb-item active" aria-current="page">Watch</li>
    </ol>
  </nav>

  <!-- Main content -->
  <div class="row">
    <!-- Video player column -->
    <div class="col-lg-9 mb-4">
      <!-- Video player container -->
      <div class="video-container" id="videoContainer">
        <!-- Loading overlay -->
        <div class="loading-overlay" id="loadingOverlay" style="display: none">
          <div class="spinner"></div>
          <p>Loading video...</p>
        </div>

        <!-- Error message (hidden by default) -->
        <div class="video-error" id="videoError" style="display: none">
          <i
            class="fas fa-exclamation-triangle fa-3x mb-3"
            style="color: #ff6b6b"
          ></i>
          <h5>Video Playback Error</h5>
          <p id="errorMessage">
            Unable to load the video. Please try again later.
          </p>
          <div class="action-buttons">
            <button class="btn btn-primary" onclick="retryVideo()">
              <i class="fas fa-redo me-2"></i>Retry
            </button>
            {% if movie.trailer_url %}
            <button class="btn btn-outline-secondary" onclick="loadTrailer()">
              <i class="fas fa-play-circle me-2"></i>Load Trailer
            </button>
            {% endif %}
            <a
              href="{{ url_for('movie_detail', movie_id=movie.id) }}"
              class="btn btn-outline-light"
            >
              <i class="fas fa-arrow-left me-2"></i>Back to Details
            </a>
          </div>
        </div>

        <!-- No content placeholder (shown when no video available) -->
        <div
          class="no-content-placeholder"
          id="noContentPlaceholder"
          style="display: none"
        >
          <i class="fas fa-film"></i>
          <h3>No Video Content Available</h3>
          <p>This movie doesn't have any video content uploaded yet.</p>
          <div class="action-buttons">
            {% if current_user.is_authenticated and current_user.is_admin %}
            <a
              href="{{ url_for('admin_upload_movie_file', movie_id=movie.id) }}"
              class="btn btn-primary"
            >
              <i class="fas fa-upload me-2"></i>Upload Video
            </a>
            {% endif %}
            <a
              href="{{ url_for('movie_detail', movie_id=movie.id) }}"
              class="btn btn-outline-light"
            >
              <i class="fas fa-info-circle me-2"></i>View Details
            </a>
          </div>
        </div>

        <!-- Video player (only shown if we have video content) -->
        {% if movie.file_path or movie.trailer_url %}
        <video
          id="movie-player"
          class="video-js vjs-default-skin vjs-big-play-centered"
          controls
          preload="auto"
          poster="{{ movie.poster_url or url_for('static', filename='images/default-poster.jpg') }}"
          data-setup='{"fluid": true, "aspectRatio": "16:9", "playbackRates": [0.5, 0.75, 1, 1.25, 1.5, 2]}'
        >
          <!-- Main movie source -->
          {% if movie.file_path %}
          <source
            src="{{ url_for('serve_movie_stream', movie_id=movie.id) }}"
            type="video/mp4"
          />
          <!-- Fallback trailer source -->
          {% elif movie.trailer_url %}
          <source src="{{ movie.trailer_url }}" type="video/mp4" />
          {% endif %}

          <!-- Subtitles -->
          {% if movie.subtitle_path %}
          <track
            kind="captions"
            src="{{ url_for('serve_subtitle', movie_id=movie.id) }}"
            srclang="en"
            label="English"
            default
          />
          {% endif %}

          <p class="vjs-no-js">
            To view this video please enable JavaScript, and consider upgrading
            to a web browser that
            <a href="https://videojs.com/html5-video-support/" target="_blank"
              >supports HTML5 video</a
            >
          </p>
        </video>
        {% endif %}
      </div>

      <!-- Movie title and info -->
      <div class="mt-4">
        <div class="d-flex justify-content-between align-items-start">
          <div>
            <h1 class="h3 mb-2">
              {{ movie.title }} {% if movie.content_rating %}
              <span class="badge bg-warning ms-2"
                >{{ movie.content_rating }}</span
              >
              {% endif %}
            </h1>
            <div class="movie-meta">
              <span class="meta-item">
                <i class="fas fa-calendar"></i> {{ movie.release_year or 'N/A'
                }}
              </span>
              {% if movie.duration %}
              <span class="meta-item">
                <i class="fas fa-clock"></i> {{ movie.duration }} min
              </span>
              {% endif %} {% if movie.imdb_rating %}
              <span class="meta-item">
                <i class="fas fa-star"></i> {{ movie.imdb_rating }}/10
              </span>
              {% endif %}
              <span class="meta-item">
                <i class="fas fa-eye"></i> {{ movie.views_count or 0 }} views
              </span>
              <span class="meta-item">
                <i class="fas fa-download"></i> {{ movie.download_count or 0 }}
                downloads
              </span>
              {% if current_user.is_authenticated and profile %}
              <span class="meta-item badge bg-primary">
                <i class="fas fa-user"></i> {{ profile.name }}
              </span>
              {% endif %}
            </div>
          </div>

          <!-- Watchlist button -->
          {% if current_user.is_authenticated %}
          <div class="watchlist-toggle">
            <button
              class="btn btn-outline-primary"
              onclick="toggleWatchlist({{ movie.id }})"
              id="watchlistBtn"
            >
              <i class="fas fa-bookmark"></i>
              <span id="watchlistText">
                {% if movie.id in watchlist_movie_ids %} In Watchlist {% else %}
                Add to Watchlist {% endif %}
              </span>
            </button>
          </div>
          {% endif %}
        </div>

        <!-- Video availability indicator -->
        <div
          class="alert {% if movie.file_path %}alert-success {% elif movie.trailer_url %}alert-info {% else %}alert-warning{% endif %} mt-3"
          id="availabilityAlert"
        >
          <i
            class="fas {% if movie.file_path %}fa-check-circle {% elif movie.trailer_url %}fa-info-circle {% else %}fa-exclamation-circle{% endif %} me-2"
          ></i>
          {% if movie.file_path %} Full movie available for streaming {% elif
          movie.trailer_url %} Trailer available (full movie coming soon) {%
          else %} Video content not available yet {% endif %}
        </div>

        <!-- Playback controls (only shown if we have video) -->
        {% if movie.file_path or movie.trailer_url %}
        <div class="playback-controls" id="playbackControls">
          <div class="speed-selector">
            <label for="playbackSpeed"
              ><i class="fas fa-tachometer-alt"></i> Speed:</label
            >
            <select
              id="playbackSpeed"
              onchange="changePlaybackSpeed(this.value)"
            >
              <option value="0.5">0.5x</option>
              <option value="0.75">0.75x</option>
              <option value="1" selected>1x (Normal)</option>
              <option value="1.25">1.25x</option>
              <option value="1.5">1.5x</option>
              <option value="2">2x</option>
            </select>
          </div>

          <div class="subtitles-selector">
            <label for="subtitleSelect"
              ><i class="fas fa-closed-captioning"></i> Subtitles:</label
            >
            <select id="subtitleSelect" onchange="changeSubtitle(this.value)">
              <option value="none">None</option>
              {% if movie.subtitle_path %}
              <option value="en" selected>English</option>
              {% endif %}
            </select>
          </div>

          <div class="ms-auto">
            <button
              class="btn btn-sm btn-outline-secondary"
              onclick="toggleFullscreen()"
            >
              <i class="fas fa-expand"></i> Fullscreen
            </button>
            <button
              class="btn btn-sm btn-outline-secondary ms-2"
              onclick="showShortcuts()"
              data-bs-toggle="tooltip"
              title="Keyboard Shortcuts"
            >
              <i class="fas fa-keyboard"></i>
            </button>
          </div>
        </div>

        <!-- Keyboard shortcuts help -->
        <div
          class="keyboard-shortcuts"
          id="shortcutsHelp"
          style="display: none"
        >
          <h6 class="mb-2">
            <i class="fas fa-keyboard me-2"></i>Keyboard Shortcuts
          </h6>
          <div class="shortcut-item">
            <span>Play/Pause</span>
            <code>Space</code> or <code>K</code>
          </div>
          <div class="shortcut-item">
            <span>Fullscreen</span>
            <code>F</code>
          </div>
          <div class="shortcut-item">
            <span>Mute/Unmute</span>
            <code>M</code>
          </div>
          <div class="shortcut-item">
            <span>Skip 10s Back</span>
            <code>←</code>
          </div>
          <div class="shortcut-item">
            <span>Skip 10s Forward</span>
            <code>→</code>
          </div>
          <div class="shortcut-item">
            <span>Volume Up/Down</span>
            <code>↑</code> / <code>↓</code>
          </div>
          <button
            class="btn btn-sm btn-outline-secondary mt-2"
            onclick="hideShortcuts()"
          >
            Hide
          </button>
        </div>
        {% endif %}
      </div>

      <!-- Movie details section -->
      <div
        class="card mt-4"
        style="background: var(--card-bg); border-color: var(--border-color)"
      >
        <div class="card-body">
          <h5 class="card-title">
            <i class="fas fa-info-circle me-2"></i>Movie Details
          </h5>

          <!-- Description -->
          <div class="mb-4">
            <h6 class="mb-2">Description</h6>
            <p class="card-text">
              {{ movie.description or 'No description available.' }}
            </p>
          </div>

          <!-- Movie details grid -->
          <div class="movie-details-grid">
            <!-- Genres -->
            {% if movie.genres %}
            <div class="detail-card">
              <h6><i class="fas fa-tags me-2"></i>Genres</h6>
              <p>
                {% for genre in movie.genres %}
                <span class="badge bg-secondary me-1 mb-1"
                  >{{ genre.name }}</span
                >
                {% endfor %}
              </p>
            </div>
            {% endif %}

            <!-- Director -->
            {% if movie.director %}
            <div class="detail-card">
              <h6><i class="fas fa-user-tie me-2"></i>Director</h6>
              <p>{{ movie.director }}</p>
            </div>
            {% endif %}

            <!-- Cast -->
            {% if movie.cast %}
            <div class="detail-card">
              <h6><i class="fas fa-users me-2"></i>Main Cast</h6>
              <p>{{ movie.cast }}</p>
            </div>
            {% endif %}

            <!-- Production Company -->
            {% if movie.production_company %}
            <div class="detail-card">
              <h6><i class="fas fa-building me-2"></i>Production</h6>
              <p>{{ movie.production_company }}</p>
            </div>
            {% endif %}

            <!-- Language -->
            {% if movie.language %}
            <div class="detail-card">
              <h6><i class="fas fa-language me-2"></i>Language</h6>
              <p>{{ movie.language }}</p>
            </div>
            {% endif %}

            <!-- Country -->
            {% if movie.country %}
            <div class="detail-card">
              <h6><i class="fas fa-globe me-2"></i>Country</h6>
              <p>{{ movie.country }}</p>
            </div>
            {% endif %}

            <!-- File Info (if available) -->
            {% if movie.file_path %}
            <div class="detail-card">
              <h6><i class="fas fa-file-video me-2"></i>File Info</h6>
              <p>
                Format: {{ movie.file_format|upper if movie.file_format else
                'MP4' }}<br />
                Size: {{ movie.file_size_formatted if movie.file_size_formatted
                else 'N/A' }}
              </p>
            </div>
            {% endif %}
          </div>

          <!-- Awards or Additional Info -->
          {% if movie.awards %}
          <div class="mt-3">
            <h6><i class="fas fa-award me-2"></i>Awards & Recognition</h6>
            <p class="mb-0">{{ movie.awards }}</p>
          </div>
          {% endif %}
        </div>
      </div>

      <!-- Reviews Section -->
      <div
        class="card mt-4"
        style="background: var(--card-bg); border-color: var(--border-color)"
      >
        <div class="card-body">
          <h5 class="card-title">
            <i class="fas fa-star me-2"></i>User Reviews
          </h5>
          {% if reviews %}
          <div class="row">
            {% for review in reviews[:3] %}
            <div class="col-md-4 mb-3">
              <div
                class="review-card p-3"
                style="background: var(--secondary-dark); border-radius: 8px"
              >
                <div class="d-flex align-items-center mb-2">
                  <div class="rating-stars">
                    {% for i in range(5) %}
                    <i
                      class="fas fa-star {% if i < review.rating %}text-warning{% else %}text-secondary{% endif %}"
                    ></i>
                    {% endfor %}
                  </div>
                  <small class="text-secondary ms-2"
                    >{{ review.created_at.strftime('%b %d, %Y') if
                    review.created_at else 'Recently' }}</small
                  >
                </div>
                <p class="mb-2" style="font-size: 0.9rem">
                  {{ review.comment[:100] }}{% if review.comment|length > 100
                  %}...{% endif %}
                </p>
                <small class="text-muted"
                  >- {{ review.user.name if review.user else 'Anonymous'
                  }}</small
                >
              </div>
            </div>
            {% endfor %}
          </div>
          {% if reviews|length > 3 %}
          <div class="text-center mt-3">
            <a
              href="{{ url_for('movie_detail', movie_id=movie.id) }}#reviews"
              class="btn btn-sm btn-outline-primary"
            >
              View All Reviews ({{ reviews|length }})
            </a>
          </div>
          {% endif %} {% else %}
          <p class="text-secondary mb-0">
            No reviews yet. Be the first to review this movie!
          </p>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Sidebar column -->
    <div class="col-lg-3">
      <!-- Download card -->
      <div
        class="card mb-4"
        style="background: var(--card-bg); border-color: var(--border-color)"
      >
        <div class="card-body">
          <h5 class="card-title">
            <i class="fas fa-download me-2"></i>Download Options
          </h5>
          {% if movie.download_enabled and movie.file_path %}
          <p class="small text-secondary mb-3">
            Download this movie to watch offline
          </p>
          <a
            href="{{ url_for('request_movie_download', movie_id=movie.id) }}"
            class="btn btn-primary w-100 mb-2"
          >
            <i class="fas fa-download me-2"></i>Download Now
          </a>
          <div class="small text-center text-secondary">
            <i class="fas fa-hdd me-1"></i> {{ movie.file_size_formatted or
            'File size: N/A' }}
          </div>
          {% elif movie.download_enabled and not movie.file_path %}
          <div class="alert alert-warning small mb-3">
            <i class="fas fa-exclamation-triangle me-1"></i>
            Movie file not uploaded yet
          </div>
          <button class="btn btn-outline-secondary w-100" disabled>
            <i class="fas fa-clock me-2"></i>Coming Soon
          </button>
          {% else %}
          <p class="text-warning small mb-0">
            <i class="fas fa-exclamation-triangle me-1"></i>
            Download not available for this movie
          </p>
          {% endif %}
        </div>
      </div>

      <!-- Technical Info -->
      <div
        class="card mb-4"
        style="background: var(--card-bg); border-color: var(--border-color)"
      >
        <div class="card-body">
          <h5 class="card-title">
            <i class="fas fa-cogs me-2"></i>Technical Info
          </h5>
          <div class="small">
            <div class="d-flex justify-content-between mb-2">
              <span class="text-secondary">Video Codec:</span>
              <span id="videoCodec">H.264</span>
            </div>
            <div class="d-flex justify-content-between mb-2">
              <span class="text-secondary">Audio Codec:</span>
              <span id="audioCodec">AAC</span>
            </div>
            <div class="d-flex justify-content-between mb-2">
              <span class="text-secondary">Resolution:</span>
              <span id="videoResolution">
                {% if movie.resolution %}{{ movie.resolution }}{% else %}1080p{%
                endif %}
              </span>
            </div>
            <div class="d-flex justify-content-between">
              <span class="text-secondary">Bitrate:</span>
              <span id="videoBitrate">
                {% if movie.bitrate %}{{ movie.bitrate }} Mbps{% else %}~3
                Mbps{% endif %}
              </span>
            </div>
          </div>
          <hr class="my-2" />
          <div class="small text-center text-secondary">
            <i class="fas fa-info-circle me-1"></i>
            Stream optimized for your connection
          </div>
        </div>
      </div>

      <!-- Similar movies -->
      {% if similar_movies %}
      <div
        class="card mb-4"
        style="background: var(--card-bg); border-color: var(--border-color)"
      >
        <div class="card-body">
          <h5 class="card-title">
            <i class="fas fa-film me-2"></i>Similar Movies
          </h5>
          <div class="list-group list-group-flush">
            {% for similar in similar_movies[:5] %}
            <a
              href="{{ url_for('movie_detail', movie_id=similar.id) }}"
              class="list-group-item list-group-item-action d-flex align-items-center"
              style="background: transparent; border-color: var(--border-color)"
            >
              <img
                src="{{ similar.poster_url or url_for('static', filename='images/default-poster.jpg') }}"
                alt="{{ similar.title }}"
                class="rounded me-3"
                style="width: 50px; height: 75px; object-fit: cover"
              />
              <div>
                <h6 class="mb-1" style="font-size: 0.85rem">
                  {{ similar.title }}
                </h6>
                <small class="text-secondary">{{ similar.release_year }}</small>
                {% if similar.imdb_rating %}
                <br />
                <small
                  ><i class="fas fa-star text-warning"></i> {{
                  similar.imdb_rating }}</small
                >
                {% endif %}
              </div>
            </a>
            {% endfor %}
          </div>
          {% if movie.genres %}
          <a
            href="{{ url_for('search') }}?genre={{ movie.genres[0].id if movie.genres else '' }}"
            class="btn btn-sm btn-outline-primary w-100 mt-3"
          >
            Browse Similar Movies
          </a>
          {% endif %}
        </div>
      </div>
      {% endif %}

      <!-- Watch Stats -->
      <div
        class="card"
        style="background: var(--card-bg); border-color: var(--border-color)"
      >
        <div class="card-body">
          <h5 class="card-title">
            <i class="fas fa-chart-bar me-2"></i>Watch Stats
          </h5>
          <div class="small">
            <div class="d-flex justify-content-between mb-2">
              <span class="text-secondary">Total Views:</span>
              <span>{{ movie.views_count }}</span>
            </div>
            <div class="d-flex justify-content-between mb-2">
              <span class="text-secondary">Total Downloads:</span>
              <span>{{ movie.download_count }}</span>
            </div>
            <div class="d-flex justify-content-between mb-2">
              <span class="text-secondary">In Watchlists:</span>
              <span>{{ watchlist_count }}</span>
            </div>
            <div class="d-flex justify-content-between">
              <span class="text-secondary">Average Rating:</span>
              <span
                >{{ average_rating|round(1) if average_rating and average_rating
                > 0 else 'Not rated' }}</span
              >
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Continue watching progress -->
  {% if continue_progress and continue_progress.current_time and
  continue_progress.duration and continue_progress.duration > 0 %}
  <div
    class="card mt-4"
    style="background: var(--card-bg); border-color: var(--border-color)"
  >
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <h5 class="card-title mb-1">
            <i class="fas fa-play-circle me-2"></i>Continue Watching
          </h5>
          <p class="text-secondary small mb-0">
            You were watching {% set current_time =
            continue_progress.current_time %} {% set duration =
            continue_progress.duration %} {% set current_hours = current_time //
            3600 %} {% set current_minutes = (current_time % 3600) // 60 %} {%
            set current_seconds = current_time % 60 %} {% set duration_hours =
            duration // 3600 %} {% set duration_minutes = (duration % 3600) //
            60 %} {% set duration_seconds = duration % 60 %} {% if current_hours
            > 0 %} {{ current_hours }}:{{ "%02d" % current_minutes }}:{{ "%02d"
            % current_seconds }} {% else %} {{ current_minutes }}:{{ "%02d" %
            current_seconds }} {% endif %} of {% if duration_hours > 0 %} {{
            duration_hours }}:{{ "%02d" % duration_minutes }}:{{ "%02d" %
            duration_seconds }} {% else %} {{ duration_minutes }}:{{ "%02d" %
            duration_seconds }} {% endif %}
          </p>
        </div>
        <button class="btn btn-primary btn-sm" onclick="resumeFromProgress()">
          <i class="fas fa-play me-1"></i> Resume
        </button>
      </div>
      <div class="progress mt-2" style="height: 6px">
        <div
          class="progress-bar bg-primary"
          role="progressbar"
          style="width: {{ ((continue_progress.current_time / continue_progress.duration) * 100)|round(1) }}%;"
          aria-valuenow="{{ ((continue_progress.current_time / continue_progress.duration) * 100)|round(1) }}"
          aria-valuemin="0"
          aria-valuemax="100"
        ></div>
      </div>
    </div>
  </div>
  {% endif %}
</div>
{% endblock %} {% block scripts %}
<!-- Video.js library -->
<script src="https://vjs.zencdn.net/8.6.1/video.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/videojs-seek-buttons/dist/videojs-seek-buttons.min.js"></script>

<script>
  // Global variables
  let player;
  let saveProgressTimeout;
  let userIsAuthenticated = {{ 'true' if current_user.is_authenticated else 'false' }};
  const movieId = {{ movie.id }};
  const hasMovieFile = {{ 'true' if movie.file_path else 'false' }};
  const hasTrailer = {{ 'true' if movie.trailer_url else 'false' }};
  const hasVideoContent = hasMovieFile || hasTrailer;
  const continueProgress = {{ continue_progress.current_time if continue_progress and continue_progress.current_time else 0 }};

  // Initialize page
  document.addEventListener('DOMContentLoaded', function() {
    // Show appropriate content based on video availability
    if (!hasVideoContent) {
      showNoContentPlaceholder();
    } else {
      initializeVideoPlayer();
    }

    initializeTooltips();
    checkVideoAvailability();
  });

  function showNoContentPlaceholder() {
    // Hide video container and show placeholder
    document.getElementById('noContentPlaceholder').style.display = 'flex';
    document.getElementById('playbackControls').style.display = 'none';
    document.getElementById('shortcutsHelp').style.display = 'none';

    // Update availability alert
    const alertDiv = document.getElementById('availabilityAlert');
    if (alertDiv) {
      alertDiv.innerHTML = `
        <i class="fas fa-exclamation-circle me-2"></i>
        Video content not available yet
      `;
      alertDiv.className = 'alert alert-warning mt-3';
    }
  }

  function initializeVideoPlayer() {
    try {
      // Show loading overlay
      document.getElementById('loadingOverlay').style.display = 'flex';

      // Check if video source exists
      const videoElement = document.getElementById('movie-player');
      if (!videoElement) {
        showNoContentPlaceholder();
        document.getElementById('loadingOverlay').style.display = 'none';
        return;
      }

      const sourceElements = videoElement.querySelectorAll('source');

      let hasValidSource = false;
      sourceElements.forEach(source => {
        if (source.src && source.src.trim() !== '') {
          hasValidSource = true;
        }
      });

      if (!hasValidSource) {
        showNoContentPlaceholder();
        document.getElementById('loadingOverlay').style.display = 'none';
        return;
      }

      // Initialize player with additional plugins
      player = videojs('movie-player', {
        fluid: true,
        aspectRatio: '16:9',
        playbackRates: [0.5, 0.75, 1, 1.25, 1.5, 2],
        plugins: {
          seekButtons: {
            forward: 10,
            back: 10
          }
        }
      });

      // Hide loading overlay when player is ready
      player.ready(function() {
        console.log('Video player initialized with source:', player.currentSrc());
        document.getElementById('loadingOverlay').style.display = 'none';

        // Set initial playback speed
        player.playbackRate(1);

        // Auto-save watch progress
        player.on('timeupdate', function() {
          clearTimeout(saveProgressTimeout);
          saveProgressTimeout = setTimeout(saveWatchProgress, 5000);
        });

        // Handle video errors
        player.on('error', handleVideoError);

        // Update video info
        player.on('loadedmetadata', function() {
          updateVideoInfo();
        });

        // Resume from progress if we have a valid continue progress
        if (continueProgress > 0) {
          setTimeout(function() {
            resumeFromProgress();
          }, 1000);
        }
      });

      // Cleanup on page unload
      window.addEventListener('beforeunload', function() {
        saveWatchProgress();
        if (player) {
          player.dispose();
        }
      });

    } catch (error) {
      console.error('Error initializing video player:', error);
      showVideoError('Failed to initialize video player. Please refresh the page.');
    }
  }

  function checkVideoAvailability() {
    // Check if we have video sources
    if (!hasVideoContent) {
      showNoContentPlaceholder();
      return false;
    }

    const videoElement = document.getElementById('movie-player');
    if (!videoElement) {
      showNoContentPlaceholder();
      return false;
    }

    const sourceElements = videoElement.querySelectorAll('source');
    let hasSource = false;

    sourceElements.forEach(source => {
      if (source.src && source.src.trim() !== '') {
        hasSource = true;
      }
    });

    if (!hasSource) {
      showNoContentPlaceholder();
      return false;
    }

    return true;
  }

  // Save watch progress to server
  function saveWatchProgress() {
    if (!userIsAuthenticated || !player) return;

    const currentTime = player.currentTime();
    const duration = player.duration();

    fetch('/api/movie/' + movieId + '/watchtime', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
      },
      body: JSON.stringify({
        current_time: currentTime,
        duration: duration
      })
    }).catch(console.error);
  }

  // Resume from progress
  function resumeFromProgress() {
    if (continueProgress > 0 && player) {
      player.currentTime(continueProgress);
      player.play();
      showToast(`Resumed from ${formatTime(continueProgress)}`, 'info');
    }
  }

  // Change playback speed
  function changePlaybackSpeed(speed) {
    if (player) {
      player.playbackRate(parseFloat(speed));
      showToast(`Playback speed: ${speed}x`, 'info');
    }
  }

  // Change subtitle
  function changeSubtitle(lang) {
    if (!player) return;

    if (lang === 'none') {
      player.textTracks().forEach(track => {
        track.mode = 'disabled';
      });
      showToast('Subtitles disabled', 'info');
    } else {
      player.textTracks().forEach(track => {
        track.mode = (track.language === lang) ? 'showing' : 'disabled';
      });
      showToast('English subtitles enabled', 'info');
    }
  }

  // Toggle fullscreen
  function toggleFullscreen() {
    if (!player) return;

    if (player.isFullscreen()) {
      player.exitFullscreen();
    } else {
      player.requestFullscreen();
    }
  }

  // Handle video errors
  function handleVideoError() {
    const error = player.error();
    console.error('Video error:', error);

    let errorMessage = 'Unable to load video content';
    if (error) {
      switch(error.code) {
        case 1: errorMessage = 'Video loading was aborted'; break;
        case 2: errorMessage = 'Network error occurred'; break;
        case 3: errorMessage = 'Video decoding failed'; break;
        case 4: errorMessage = 'Video format not supported'; break;
        case 5: errorMessage = 'Video encryption error'; break;
      }
    }

    showVideoError(errorMessage);
  }

  // Show video error
  function showVideoError(message) {
    document.getElementById('errorMessage').textContent = message;
    document.getElementById('videoError').style.display = 'block';
    document.getElementById('loadingOverlay').style.display = 'none';
  }

  // Hide video error
  function hideVideoError() {
    document.getElementById('videoError').style.display = 'none';
  }

  // Retry video loading
  function retryVideo() {
    hideVideoError();
    if (player) {
      player.src(player.currentSrc());
      player.load();
      player.play();
    }
  }

  // Load trailer
  function loadTrailer() {
    hideVideoError();
    if (player && hasTrailer) {
      player.src("{{ movie.trailer_url }}");
      player.load();
      player.play();
      showToast('Loaded trailer', 'info');
    }
  }

  // Update video information
  function updateVideoInfo() {
    if (!player) return;

    try {
      // Get video element
      const videoEl = player.tech().el();
      const width = videoEl.videoWidth || 0;
      const height = videoEl.videoHeight || 0;

      // Update resolution display
      if (width && height) {
        document.getElementById('videoResolution').textContent = `${width}x${height}`;
      }

      // Update codec info based on file extension
      const src = player.currentSrc();
      if (src) {
        if (src.includes('.webm')) {
          document.getElementById('videoCodec').textContent = 'VP9';
        } else if (src.includes('.mkv')) {
          document.getElementById('videoCodec').textContent = 'H.265';
        } else {
          document.getElementById('videoCodec').textContent = 'H.264';
        }
      }

    } catch (error) {
      console.error('Error updating video info:', error);
    }
  }

  // Toggle watchlist
  function toggleWatchlist(movieId) {
    if (!userIsAuthenticated) {
      window.location.href = "{{ url_for('login') }}";
      return;
    }

    fetch('/api/watchlist/' + movieId + '/toggle', {
      method: 'POST',
      headers: {
        'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        const btn = document.getElementById('watchlistBtn');
        const text = document.getElementById('watchlistText');

        if (data.action === 'added') {
          btn.classList.remove('btn-outline-primary');
          btn.classList.add('btn-primary');
          text.innerHTML = '<i class="fas fa-check me-1"></i> In Watchlist';
          showToast('Added to watchlist', 'success');
        } else {
          btn.classList.remove('btn-primary');
          btn.classList.add('btn-outline-primary');
          text.innerHTML = '<i class="fas fa-bookmark me-1"></i> Add to Watchlist';
          showToast('Removed from watchlist', 'info');
        }
      }
    })
    .catch(error => {
      console.error('Watchlist error:', error);
      showToast('Failed to update watchlist', 'danger');
    });
  }

  // Format time function
  function formatTime(seconds) {
    if (!seconds) return '0:00';

    const hrs = Math.floor(seconds / 3600);
    const mins = Math.floor((seconds % 3600) / 60);
    const secs = Math.floor(seconds % 60);

    if (hrs > 0) {
      return `${hrs}:${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    } else {
      return `${mins}:${secs.toString().padStart(2, '0')}`;
    }
  }

  // Toast notification
  function showToast(message, type = 'info') {
    // Create toast container if it doesn't exist
    let toastContainer = document.getElementById('toast-container');
    if (!toastContainer) {
      toastContainer = document.createElement('div');
      toastContainer.id = 'toast-container';
      toastContainer.style.cssText = `
        position: fixed;
        top: 80px;
        right: 20px;
        z-index: 9999;
        min-width: 250px;
      `;
      document.body.appendChild(toastContainer);
    }

    // Create toast
    const toastId = 'toast-' + Date.now();
    const toast = document.createElement('div');
    toast.id = toastId;
    toast.className = `toast align-items-center text-bg-${type} border-0`;
    toast.setAttribute('role', 'alert');
    toast.setAttribute('aria-live', 'assertive');
    toast.setAttribute('aria-atomic', 'true');

    const icon = type === 'success' ? 'check-circle' :
                 type === 'danger' ? 'exclamation-triangle' :
                 type === 'warning' ? 'exclamation-circle' : 'info-circle';

    toast.innerHTML = `
      <div class="d-flex">
        <div class="toast-body">
          <i class="fas fa-${icon} me-2"></i>
          ${message}
        </div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
    `;

    toastContainer.appendChild(toast);

    // Show toast
    const bsToast = new bootstrap.Toast(toast, { delay: 3000 });
    bsToast.show();

    // Remove toast after it's hidden
    toast.addEventListener('hidden.bs.toast', function () {
      toast.remove();
    });
  }

  // Initialize tooltips
  function initializeTooltips() {
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.map(function (tooltipTriggerEl) {
      return new bootstrap.Tooltip(tooltipTriggerEl);
    });
  }

  function showShortcuts() {
    document.getElementById('shortcutsHelp').style.display = 'block';
  }

  function hideShortcuts() {
    document.getElementById('shortcutsHelp').style.display = 'none';
  }

  // Keyboard shortcuts
  document.addEventListener('keydown', function (e) {
    // Don't trigger if user is typing in an input
    if (e.target.tagName === "INPUT" || e.target.tagName === "TEXTAREA" || e.target.isContentEditable) return;

    if (!player) return;

    switch (e.key) {
      case " ":
      case "k":
        e.preventDefault();
        if (player.paused()) {
          player.play();
        } else {
          player.pause();
        }
        break;
      case "f":
        e.preventDefault();
        toggleFullscreen();
        break;
      case "m":
        e.preventDefault();
        player.muted(!player.muted());
        showToast(player.muted() ? 'Muted' : 'Unmuted', 'info');
        break;
      case "ArrowLeft":
        e.preventDefault();
        player.currentTime(player.currentTime() - 10);
        break;
      case "ArrowRight":
        e.preventDefault();
        player.currentTime(player.currentTime() + 10);
        break;
      case "ArrowUp":
        e.preventDefault();
        player.volume(Math.min(player.volume() + 0.1, 1));
        break;
      case "ArrowDown":
        e.preventDefault();
        player.volume(Math.max(player.volume() - 0.1, 0));
        break;
      case "?":
        e.preventDefault();
        showShortcuts();
        break;
      case "Escape":
        if (document.getElementById('shortcutsHelp').style.display === 'block') {
          hideShortcuts();
        }
        break;
    }
  });
</script>
{% endblock %}
