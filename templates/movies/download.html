{% extends "base.html" %} {% block title %}Download {{ movie.title }} -
CineWave{% endblock %} {% block content %}
<div class="container mt-5 pt-5">
  <div class="row justify-content-center">
    <div class="col-lg-8">
      <!-- Download Header -->
      <div
        class="card mb-4"
        style="
          background: linear-gradient(
            135deg,
            var(--primary-dark) 0%,
            var(--tertiary-dark) 100%
          );
          border: none;
        "
      >
        <div class="card-body p-4">
          <div class="row align-items-center">
            <div class="col-md-3">
              <img
                src="{{ movie.poster_url or 'https://via.placeholder.com/200x300/172a45/8892b0?text=No+Poster' }}"
                alt="{{ movie.title }}"
                class="img-fluid rounded"
              />
            </div>
            <div class="col-md-9">
              <h1 class="h3 mb-2" style="color: var(--text-primary)">
                <i
                  class="fas fa-download me-2"
                  style="color: var(--primary-blue)"
                ></i>
                Download {{ movie.title }}
              </h1>
              <p class="text-secondary mb-3">
                Your download is being prepared. Please wait a moment.
              </p>
              <div class="d-flex flex-wrap gap-2 mb-3">
                <span class="badge bg-primary"
                  >{{ movie.release_year or 'N/A' }}</span
                >
                <span class="badge bg-secondary">{{ movie.duration }} min</span>
                <span class="badge bg-info"
                  >{{ movie.file_size_formatted }}</span
                >
                {% if movie.file_format %}
                <span class="badge bg-warning"
                  >{{ movie.file_format|upper }}</span
                >
                {% endif %}
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Download Progress -->
      <div
        class="card mb-4"
        style="background: var(--card-bg); border-color: var(--border-color)"
      >
        <div class="card-body">
          <h5 class="card-title mb-3">
            <i
              class="fas fa-spinner fa-spin me-2"
              style="color: var(--primary-blue)"
            ></i>
            Preparing Your Download
          </h5>

          <div class="mb-4">
            <div class="d-flex justify-content-between mb-2">
              <span class="text-secondary">Progress</span>
              <span class="text-secondary" id="progressPercent">0%</span>
            </div>
            <div class="progress" style="height: 10px">
              <div
                class="progress-bar progress-bar-striped progress-bar-animated"
                role="progressbar"
                style="width: 0%"
                id="progressBar"
              ></div>
            </div>
          </div>

          <div class="row">
            <div class="col-md-6 mb-3">
              <div class="d-flex align-items-center">
                <div class="me-3">
                  <i
                    class="fas fa-file-alt fa-2x"
                    style="color: var(--primary-blue)"
                  ></i>
                </div>
                <div>
                  <div class="text-secondary small">File Size</div>
                  <div class="fw-bold">{{ movie.file_size_formatted }}</div>
                </div>
              </div>
            </div>
            <div class="col-md-6 mb-3">
              <div class="d-flex align-items-center">
                <div class="me-3">
                  <i
                    class="fas fa-download fa-2x"
                    style="color: var(--primary-blue)"
                  ></i>
                </div>
                <div>
                  <div class="text-secondary small">Format</div>
                  <div class="fw-bold">
                    {{ movie.file_format|upper or 'MP4' }}
                  </div>
                </div>
              </div>
            </div>
            <div class="col-md-6 mb-3">
              <div class="d-flex align-items-center">
                <div class="me-3">
                  <i
                    class="fas fa-clock fa-2x"
                    style="color: var(--primary-blue)"
                  ></i>
                </div>
                <div>
                  <div class="text-secondary small">Estimated Time</div>
                  <div class="fw-bold" id="estimatedTime">Calculating...</div>
                </div>
              </div>
            </div>
            <div class="col-md-6 mb-3">
              <div class="d-flex align-items-center">
                <div class="me-3">
                  <i
                    class="fas fa-wifi fa-2x"
                    style="color: var(--primary-blue)"
                  ></i>
                </div>
                <div>
                  <div class="text-secondary small">Speed</div>
                  <div class="fw-bold" id="downloadSpeed">-- MB/s</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Download Instructions -->
      <div
        class="card mb-4"
        style="background: var(--card-bg); border-color: var(--border-color)"
      >
        <div class="card-body">
          <h5 class="card-title mb-3">
            <i
              class="fas fa-info-circle me-2"
              style="color: var(--primary-blue)"
            ></i>
            Download Information
          </h5>

          <div class="row">
            <div class="col-md-6 mb-3">
              <div class="alert alert-info">
                <i class="fas fa-mobile-alt me-2"></i>
                <strong>Mobile Devices:</strong> Ensure you have enough storage
                space.
              </div>
            </div>
            <div class="col-md-6 mb-3">
              <div class="alert alert-info">
                <i class="fas fa-laptop me-2"></i>
                <strong>Computers:</strong> Use a download manager for large
                files.
              </div>
            </div>
          </div>

          <ul class="text-secondary">
            <li class="mb-2">Download will start automatically when ready</li>
            <li class="mb-2">Keep this page open until download completes</li>
            <li class="mb-2">Do not refresh the page during download</li>
            <li class="mb-2">Download link is valid for 1 hour</li>
            <li>You can download this movie up to 3 times</li>
          </ul>
        </div>
      </div>

      <!-- Download Actions -->
      <div
        class="card"
        style="background: var(--card-bg); border-color: var(--border-color)"
      >
        <div class="card-body text-center">
          <div class="mb-3" id="downloadButtonContainer">
            <a
              href="{{ url_for('download_movie_file', token=download_token) }}"
              class="btn btn-primary btn-lg disabled"
              id="downloadButton"
              style="min-width: 200px"
            >
              <i class="fas fa-spinner fa-spin me-2"></i>
              Preparing...
            </a>
          </div>

          <div class="d-flex flex-wrap gap-2 justify-content-center">
            <a
              href="{{ url_for('movie_detail', movie_id=movie.id) }}"
              class="btn btn-outline-primary"
            >
              <i class="fas fa-arrow-left me-2"></i>Back to Movie
            </a>
            <a
              href="{{ url_for('movies_index') }}"
              class="btn btn-outline-primary"
            >
              <i class="fas fa-film me-2"></i>Browse Movies
            </a>
            <a
              href="{{ url_for('user_downloads') }}"
              class="btn btn-outline-primary"
            >
              <i class="fas fa-history me-2"></i>Download History
            </a>
          </div>

          <div class="mt-3">
            <p class="text-secondary small mb-0">
              <i class="fas fa-shield-alt me-1"></i>
              This download is protected by DRM and for personal use only.
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // Download progress simulation
  let progress = 0;
  let speed = 0;
  const totalSize = {{ movie.file_size or 1000000000 }}; // Default 1GB if not set
  let startTime = new Date();

  function updateProgress() {
      if (progress < 100) {
          // Simulate progress
          progress += Math.random() * 10;
          if (progress > 100) progress = 100;

          // Calculate speed
          const currentTime = new Date();
          const elapsedSeconds = (currentTime - startTime) / 1000;
          const downloadedSize = (progress / 100) * totalSize;
          speed = (downloadedSize / (1024 * 1024)) / elapsedSeconds; // MB/s

          // Update UI
          document.getElementById('progressBar').style.width = progress + '%';
          document.getElementById('progressPercent').textContent = Math.round(progress) + '%';
          document.getElementById('downloadSpeed').textContent = speed.toFixed(2) + ' MB/s';

          // Calculate estimated time
          const remainingSize = totalSize - downloadedSize;
          const estimatedSeconds = remainingSize / (speed * 1024 * 1024);
          document.getElementById('estimatedTime').textContent = formatTime(estimatedSeconds);

          // Enable download button at 100%
          if (progress >= 100) {
              completeDownload();
          }
      }
  }

  function completeDownload() {
      const downloadBtn = document.getElementById('downloadButton');
      const downloadContainer = document.getElementById('downloadButtonContainer');

      downloadBtn.classList.remove('disabled');
      downloadBtn.innerHTML = '<i class="fas fa-download me-2"></i>Start Download';

      // Add click tracking
      downloadBtn.addEventListener('click', function(e) {
          trackDownloadStart();
      });

      // Show success message
      const successDiv = document.createElement('div');
      successDiv.className = 'alert alert-success alert-dismissible fade show mt-3';
      successDiv.innerHTML = `
          <i class="fas fa-check-circle me-2"></i>
          Download ready! Click the button above to start.
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      `;
      downloadContainer.appendChild(successDiv);
  }

  function formatTime(seconds) {
      if (seconds < 0) return '--';

      if (seconds < 60) {
          return Math.round(seconds) + ' seconds';
      } else if (seconds < 3600) {
          const minutes = Math.floor(seconds / 60);
          return minutes + ' minute' + (minutes > 1 ? 's' : '');
      } else {
          const hours = Math.floor(seconds / 3600);
          const minutes = Math.floor((seconds % 3600) / 60);
          return hours + 'h ' + minutes + 'm';
      }
  }

  function trackDownloadStart() {
      // Send analytics event
      fetch('/api/track/download/{{ download_id }}', {
          method: 'POST',
          headers: {
              'Content-Type': 'application/json',
              'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
          }
      }).catch(console.error);
  }

  // Start progress simulation
  document.addEventListener('DOMContentLoaded', function() {
      // Initial delay before starting
      setTimeout(() => {
          setInterval(updateProgress, 500);
      }, 1000);

      // Check download status via API
      checkDownloadStatus();
  });

  function checkDownloadStatus() {
      fetch('{{ url_for("download_status", download_id=download_id) }}')
          .then(response => response.json())
          .then(data => {
              if (data.status === 'completed') {
                  completeDownload();
              }
          })
          .catch(console.error);
  }
</script>
{% endblock %}
